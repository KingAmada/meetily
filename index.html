<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meetily | Premium Safety Companion</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/nigeriaLow.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="icon" type="image/png" href="./favicon.png" />
  <link rel="shortcut icon" type="image/png" href="./favicon.png" />

  <style>
    :root{
      --primary-blue:#1e3a8a;
      --deep-blue:#0b1538;
      --light-blue:#eef2ff;
      --vibrant-cyan:#60a5fa;
      --emergency-rose:#f43f5e;
      --card-white:#ffffff;
      --text-main:#0c4a6e;
      --header-h:64px;
      --nav-h:80px;
    }

    body{
      font-family:'Inter',sans-serif;
      background:#ffffff;
      color:var(--text-main);
      min-height:100vh;
    }

    @keyframes flow{
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }
    .animated-bg{
      position:relative;
      background:#ffffff;
      background-size:400% 400%;
      animation:flow 18s ease infinite;
    }
    .animated-bg::before,
    .animated-bg::after{
      content:"";
      position:fixed;
      border-radius:9999px;
      filter:blur(12px);
      pointer-events:none;
      z-index:0;
      opacity:.72;
      animation:floatBlob 18s ease-in-out infinite;
    }
    .animated-bg::before{
      width:280px;
      height:280px;
      background:radial-gradient(circle at 30% 30%, rgba(30,58,138,.16), rgba(255,255,255,0));
      top:-90px;
      left:-80px;
    }
    .animated-bg::after{
      width:340px;
      height:340px;
      background:radial-gradient(circle at 70% 60%, rgba(37,99,235,.14), rgba(255,255,255,0));
      bottom:-140px;
      right:-100px;
      animation-delay:-7s;
    }
    @keyframes floatBlob{
      0%,100%{transform:translate3d(0,0,0) scale(1);}
      50%{transform:translate3d(0,-14px,0) scale(1.05);}
    }

    @keyframes rotate{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
    .gradient-border-card{
      position:relative;border-radius:1.5rem;z-index:1;overflow:hidden;padding:2px;
      box-shadow:0 10px 25px -5px rgba(14,165,233,0.15);
    }
    .gradient-border-card::before{
      content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
      background:conic-gradient(transparent,var(--primary-blue),transparent,var(--vibrant-cyan),transparent);
      animation:rotate 6s linear infinite;z-index:-1;
    }
    .white-inner{background:var(--card-white);border-radius:1.45rem;height:100%;width:100%;}

    /* Screens must account for header + fixed bottom nav */
    .app-screen{
      height: calc(100vh - var(--header-h) - var(--nav-h));
      display:none;
      flex-direction:column;
      animation: slideUp .5s cubic-bezier(0.16,1,0.3,1);
      overflow-y:auto;
      padding-bottom: 24px;
      scrollbar-width:none;
    }
    .app-screen::-webkit-scrollbar{display:none;}

    @keyframes slideUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}

    .nav-item{color:#94a3b8;transition:all .3s ease;}
    .nav-item.active{color:var(--primary-blue);}

    .form-input{
      background:rgba(255,255,255,.78);border:1px solid rgba(15,23,42,.1);color:var(--text-main);
      border-radius:1.25rem;padding:1.1rem;width:100%;
      transition:all .3s;box-shadow:0 10px 22px -20px rgba(15,23,42,.35);
      backdrop-filter: blur(8px);
    }
    .form-input:focus{
      outline:none;border-color:var(--primary-blue);
      box-shadow:0 0 0 4px rgba(14,165,233,0.1);
    }
    .form-input.input-error{
      border-color:#ef4444;
      background:#fff1f2;
      box-shadow:0 0 0 4px rgba(239,68,68,0.14);
    }
    .field-error{
      color:#b91c1c;
      font-size:11px;
      font-weight:700;
      margin-top:6px;
      letter-spacing:.03em;
      text-transform:uppercase;
    }

    .btn-primary{
      background:linear-gradient(135deg,#0b1538,#1e3a8a,#1d4ed8,#0b1538);
      background-size:240% 240%;
      animation:metalFlow 6.2s ease infinite;
      color:white;transition:all .3s;
      box-shadow:0 12px 24px -8px rgba(11,21,56,.45);
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 20px 34px -12px rgba(11,21,56,.5);}
    .btn-primary:active{transform:scale(0.96);}
    @keyframes metalFlow{
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .btn-spinner{
      display:inline-block;
      width:14px;
      height:14px;
      border:2px solid rgba(255,255,255,0.45);
      border-top-color:#ffffff;
      border-radius:9999px;
      animation:spin .75s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }

    .stat-card{
      background:rgba(255,255,255,.75);
      border:1px solid rgba(15,23,42,.08);
      border-radius:1.5rem;
      box-shadow:0 24px 34px -28px rgba(15,23,42,.35), 0 6px 14px -10px rgba(15,23,42,.18);
      backdrop-filter:blur(12px);
      transition:transform .35s ease, box-shadow .35s ease;
    }
    .stat-card:hover{
      transform:translateY(-2px);
      box-shadow:0 28px 36px -26px rgba(15,23,42,.35), 0 8px 16px -12px rgba(15,23,42,.18);
    }
    @keyframes shimmer{0%{background-position:-100% 0;}100%{background-position:200% 0;}}
    .glass-shimmer{
      background:linear-gradient(100deg, rgba(255,255,255,.06) 20%, rgba(255,255,255,.32) 45%, rgba(255,255,255,.08) 70%);
      background-size:220% 100%;
      animation:shimmer 4s linear infinite;
    }
    .package-choices{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;}
    .package-pill{
      border-radius:12px;
      border:1px solid rgba(30,58,138,.18);
      background:rgba(255,255,255,.88);
      padding:9px 8px;
      text-align:center;
      transition:all .22s ease;
      box-shadow:0 6px 18px -14px rgba(11,21,56,.45);
    }
    .package-pill .name{font-size:10px;font-weight:900;letter-spacing:.06em;text-transform:uppercase;color:#1e3a8a;}
    .package-pill .price{font-size:13px;font-weight:900;color:#0f172a;margin-top:2px;}
    .package-pill:hover{transform:translateY(-1px);border-color:rgba(29,78,216,.5);}
    .package-pill.active{
      border-color:#1d4ed8;
      box-shadow:0 12px 24px -16px rgba(29,78,216,.8);
      background:linear-gradient(180deg, rgba(239,246,255,.95), rgba(255,255,255,.95));
    }
    .package-detail{
      margin-top:8px;
      border-radius:12px;
      border:1px solid rgba(30,58,138,.12);
      background:rgba(255,255,255,.72);
      padding:10px 12px;
      font-size:11px;
      color:#334155;
      line-height:1.35;
      min-height:42px;
    }
    button:disabled{
      opacity:.62;
      cursor:not-allowed;
      filter:saturate(.72);
    }

    /* Social Proof Toast */
    #social-proof-toast{
      position:fixed;
      bottom: calc(var(--nav-h) + 18px);
      left:24px; right:24px;
      z-index:70;
      transform:translateY(160%);
      opacity:0;
      transition: transform .45s cubic-bezier(0.23,1,0.32,1), opacity .35s ease;
      pointer-events:none;
    }
    #social-proof-toast.show{
      transform:translateY(0);
      opacity:1;
    }

    .hero-img-container{width:100%;height:220px;overflow:hidden;border-radius:2rem;position:relative;box-shadow:0 20px 25px -5px rgba(14,165,233,0.1);}
    .hero-img-container img{width:100%;height:100%;object-fit:cover;}
    .hero-slide-img{transition:opacity .55s ease, transform 6s ease;opacity:1;transform:scale(1);}
    .hero-slide-img.is-changing{opacity:.2;transform:scale(1.03);}
    .step-img{width:80px;height:80px;object-fit:cover;border-radius:1rem;}

    .file-input-label{
      display:inline-block;cursor:pointer;padding:10px 16px;
      background-color:#f0f9ff;color:var(--primary-blue);
      border:1px dashed var(--primary-blue);
      border-radius:12px;transition:all .3s ease;font-size:.8rem;font-weight:600;
    }

    @keyframes scan{0%{top:0%;}100%{top:100%;}}
    .scan-line{
      position:absolute;width:100%;height:2px;background:var(--vibrant-cyan);
      box-shadow:0 0 10px var(--vibrant-cyan);
      animation:scan 2s linear infinite alternate;
    }

    @keyframes dotBlink{
      0%,100%{opacity:.25;transform:scale(.85);}
      50%{opacity:1;transform:scale(1.2);}
    }
    .map-dot{animation:dotBlink 1.8s ease-in-out infinite;transform-origin:center;}
    .map-dot-green{fill:#22c55e;}
    .map-dot-yellow{fill:#eab308;}
  </style>
</head>

<body class="animated-bg overflow-hidden">

  <div class="max-w-md mx-auto h-screen shadow-2xl overflow-hidden relative border-x border-slate-200 bg-white/85 backdrop-blur-xl">

    <!-- Social Proof Toast -->
    <div id="social-proof-toast">
      <div class="bg-white/90 backdrop-blur-md border border-blue-100 shadow-xl rounded-2xl p-4 flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
          <i class="ph-bold ph-user-circle text-blue-600 text-xl"></i>
        </div>
        <div>
          <p id="toast-text" class="text-xs font-medium text-blue-900 leading-tight">Someone in Lagos just logged a meetup.</p>
          <p class="text-[10px] text-blue-400 font-bold uppercase mt-1">Verified User • Now</p>
        </div>
      </div>
    </div>

    <!-- Global Header -->
    <header class="h-16 flex items-center justify-between px-6 bg-white/80 backdrop-blur-md sticky top-0 z-[60] border-b border-blue-100">
      <div class="flex items-center gap-2">
        <i class="ph-bold ph-shield-check text-cyan-500 text-2xl"></i>
        <span class="font-extrabold text-xl tracking-tight text-blue-900 uppercase">Meetily</span>
      </div>
      <div id="user-info-reveal" class="hidden flex items-center gap-3">
        <span id="header-user-name" class="text-xs font-black text-blue-700 uppercase tracking-widest"></span>
        <div class="w-8 h-8 rounded-full bg-blue-100 border border-blue-200 flex items-center justify-center">
          <i class="ph-bold ph-user text-blue-600"></i>
        </div>
      </div>
    </header>

    <div class="relative w-full h-full">

      <!-- SCREEN: LANDING -->
      <div id="screen-landing" class="app-screen p-6 space-y-10">
        <div class="space-y-4 pt-4">
          <div class="hero-img-container">
            <img id="landing-hero-image" class="hero-slide-img" src="https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?auto=format&fit=crop&q=80&w=800" alt="Traveler safety">
            <div class="absolute inset-0 bg-gradient-to-t from-blue-900/60 to-transparent"></div>
            <div class="absolute bottom-4 left-6 right-6">
              <p id="landing-hero-badge" class="text-white text-sm font-bold uppercase tracking-widest drop-shadow-md">Verified Secure Logging</p>
            </div>
          </div>
          <h1 id="landing-hero-headline" class="text-4xl font-extrabold leading-tight text-blue-900">Meetily Log Meetups.</h1>
          <p id="landing-hero-subtext" class="text-lg text-slate-600 leading-relaxed">Going on a date or meeting a stranger? logging it gives you a 48-hour safety net.</p>
          <div class="flex flex-col gap-3">
            <button id="btn-landing-signup" class="w-full btn-primary font-bold py-5 rounded-2xl shadow-xl">
              Sign Up
            </button>
            <button id="btn-landing-signin" class="w-full bg-white text-blue-700 border border-blue-200 font-bold py-4 rounded-2xl shadow-sm">
              Sign In
            </button>
          </div>
          <p class="text-center text-xs font-bold text-slate-500">Your spirit might hunt them or not, but Meetily will ensure police have neccessary data incase of what we don't pray for happen</p>
        </div>

        <div class="bg-blue-600 text-white p-6 rounded-[2.5rem] text-center shadow-xl shadow-blue-500/30">
          <p class="font-black text-lg">Trusted by over 15,432 Solo Users</p>
        </div>

        <div class="bg-gradient-to-br from-blue-900 to-blue-700 p-8 rounded-[3rem] text-white space-y-8 shadow-2xl">
          <h2 class="text-3xl font-black leading-tight">Don't Be A Statistic.</h2>
          <p class="text-blue-100 text-sm">Every year, thousands of solo travelers face unforeseen dangers. Prep is key.</p>

          <div class="grid grid-cols-1 gap-6">
            <div class="flex items-center gap-4">
              <span class="text-4xl font-black text-cyan-300 drop-shadow-sm">7m</span>
              <p class="text-[10px] text-blue-100 uppercase font-black tracking-widest leading-tight">Avg. time for report initiation</p>
            </div>
            <div class="flex items-center gap-4 border-t border-blue-800 pt-4">
              <span class="text-4xl font-black text-cyan-300 drop-shadow-sm">48%</span>
              <p class="text-[10px] text-blue-100 uppercase font-black tracking-widest leading-tight">Increase in incidents without plans</p>
            </div>
            <div class="flex items-center gap-4 border-t border-blue-800 pt-4">
              <span class="text-4xl font-black text-emerald-400 drop-shadow-sm">1 Click</span>
              <p class="text-[10px] text-blue-100 uppercase font-black tracking-widest leading-tight">To secure your log instantly</p>
            </div>
          </div>
          <p class="text-center font-bold italic text-blue-200 pt-4">Don't Wait, Secure Your Trip.</p>
        </div>

        <div class="space-y-8">
          <h2 class="text-2xl font-black text-blue-900 text-center">Safety in 3 Simple Steps</h2>

          <div class="space-y-10">
            <div class="flex flex-col gap-4">
              <div class="flex items-center gap-4">
                <div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center font-black flex-shrink-0">1</div>
                <h3 class="font-bold text-xl text-blue-900 leading-none">Create Your Profile</h3>
              </div>
              <div class="flex gap-4">
                <img src="https://images.unsplash.com/photo-1512314889357-e157c22f938d?auto=format&fit=crop&q=80&w=200" class="step-img" alt="Step 1">
                <p class="text-sm text-slate-500 leading-relaxed">Sign up and add your emergency contacts (Next of Kin, Trusted Friend). This information is encrypted and private.</p>
              </div>
            </div>

            <div class="flex flex-col gap-4">
              <div class="flex items-center gap-4">
                <div class="bg-cyan-100 text-cyan-600 w-10 h-10 rounded-full flex items-center justify-center font-black flex-shrink-0">2</div>
                <h3 class="font-bold text-xl text-blue-900 leading-none">Log Your Stay</h3>
              </div>
              <div class="flex gap-4">
                <img src="https://images.unsplash.com/photo-1551820842-77bb5df74b5c?auto=format&fit=crop&q=80&w=200" class="step-img" alt="Step 2">
                <p class="text-sm text-slate-500 leading-relaxed">Before you check in, log your hotel name, room number, and expected check-out date. Use auto-location for precise GPS data.</p>
              </div>
            </div>

            <div class="flex flex-col gap-4">
              <div class="flex items-center gap-4">
                <div class="bg-emerald-100 text-emerald-600 w-10 h-10 rounded-full flex items-center justify-center font-black flex-shrink-0">3</div>
                <h3 class="font-bold text-xl text-blue-900 leading-none">Travel Confidently</h3>
              </div>
              <div class="flex gap-4">
                <img src="https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?auto=format&fit=crop&q=80&w=200" class="step-img" alt="Step 3">
                <p class="text-sm text-slate-500 leading-relaxed">Relax knowing there's a secure record of your whereabouts and emergency profile setup for rapid response.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Testimonials -->
        <div class="space-y-5">
          <h2 class="text-2xl font-black text-blue-900 text-center">What Our Users Say</h2>
          <div id="testimonial-card" class="stat-card p-8 border-l-8 border-blue-500 transition-all duration-500">
            <p id="testimonial-quote" class="text-sm text-slate-600 italic leading-relaxed"></p>
            <div class="mt-6 flex items-center gap-4">
              <img id="testimonial-avatar" src="" class="w-12 h-12 rounded-full border-4 border-blue-50 shadow-md object-cover" alt="User testimonial">
              <div>
                <span id="testimonial-name" class="block font-black text-blue-900"></span>
                <span id="testimonial-role" class="text-[10px] text-blue-400 uppercase font-black tracking-widest"></span>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-center gap-2">
            <span id="testimonial-dot-0" class="w-2 h-2 rounded-full bg-blue-500"></span>
            <span id="testimonial-dot-1" class="w-2 h-2 rounded-full bg-blue-200"></span>
            <span id="testimonial-dot-2" class="w-2 h-2 rounded-full bg-blue-200"></span>
          </div>
        </div>

        <div class="pb-12 text-center">
          <p class="text-slate-400 text-[10px] uppercase font-black tracking-[0.3em]">Guardian Angel App v2.0</p>
        </div>
      </div>

      <!-- SCREEN: AUTH -->
      <div id="screen-auth" class="app-screen p-8 space-y-8">
        <div class="space-y-2 text-center pt-8">
          <h1 id="auth-title" class="text-3xl font-extrabold text-blue-900">Sign Up</h1>
          <p id="auth-subtitle" class="text-slate-500">Enter your details to proceed.</p>
        </div>
        <form id="auth-form" class="space-y-4">
          <div id="signup-fields">
            <input type="text" id="auth-name" placeholder="Full Name" class="form-input">
          </div>
          <input type="tel" id="auth-phone" placeholder="Phone Number" maxlength="11"
                 inputmode="numeric"
                 oninput="this.value=this.value.replace(/\\D/g,'')"
                 pattern="[0-9]{11}" minlength="11"
                 required class="form-input">
          <input type="password" id="auth-pin" inputmode="numeric" pattern="[0-9]*" maxlength="4"
                 placeholder="4-Digit PIN"
                 oninput="this.value=this.value.replace(/\\D/g,'')"
                 required class="form-input text-center text-2xl tracking-[0.5em]">

          <button id="auth-submit-btn" type="submit" class="w-full btn-primary font-bold py-4 rounded-2xl shadow-lg mt-4">Create Account</button>
        </form>
        <button type="button" id="btn-toggle-auth" class="w-full text-center text-sm font-semibold text-blue-600">Already have an account? Sign In</button>
      </div>

      <!-- SCREEN: HOME -->
      <div id="screen-home" class="app-screen p-6 space-y-6">
        <div class="flex justify-between items-center">
          <h1 class="text-2xl font-extrabold text-blue-900">Dashboard</h1>
          <div class="flex items-center gap-3">
            <i class="ph-bold ph-bell text-blue-400 text-2xl"></i>
          </div>
        </div>

        <!-- This ID was missing in your HTML but referenced in JS -->
        <div id="no-active-meetup" class="stat-card p-6 min-h-[192px] flex flex-col justify-center items-center gap-4 text-center">
            <p class="font-bold text-blue-900 text-lg">Going on a date or meeting a stranger?</p>
            <p class="text-xs text-slate-500">A 2-minute log gives you a 48-hour safety net.</p>
            <button id="btn-home-log" class="btn-primary px-10 py-3 rounded-2xl font-bold text-sm">
              Log New Meetup
            </button>
            <p class="text-[11px] text-slate-500 font-semibold">Your spirit might hunt them or not, but Meetily will ensure police have neccessary data incase of what we don't pray for happen</p>
        </div>

        <div id="active-meetup-card-home" class="hidden stat-card cursor-pointer p-5 min-h-[92px] flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-2xl bg-blue-100 flex items-center justify-center">
              <i class="ph-bold ph-timer text-blue-600 text-2xl animate-pulse"></i>
            </div>
            <div>
              <span id="active-meetup-name-display" class="block font-black text-blue-900">Logging Active</span>
              <span class="text-[10px] text-blue-500 font-bold uppercase tracking-widest">Tap to view details</span>
            </div>
          </div>
          <i class="ph-bold ph-caret-right text-blue-300"></i>
        </div>

        <h2 class="text-lg font-black text-blue-900 mt-4 uppercase tracking-wider">Safety Pulse</h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="stat-card p-6 text-center">
            <span class="block text-3xl font-black text-blue-600">15k+</span>
            <span class="text-[8px] text-slate-400 uppercase font-black tracking-[0.2em]">Active Watch</span>
          </div>
          <div class="stat-card p-6 text-center">
            <span class="block text-3xl font-black text-emerald-500">100%</span>
            <span class="text-[8px] text-slate-400 uppercase font-black tracking-[0.2em]">Private</span>
          </div>
        </div>

        <div class="stat-card p-5 space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="text-xs font-black text-blue-400 uppercase tracking-widest">Live Users in Nigeria</h3>
            <span id="active-users-count" class="text-sm font-black text-blue-700">0 Users</span>
          </div>
          <div class="grid grid-cols-2 gap-3 text-[10px] uppercase font-black tracking-widest">
            <div class="bg-emerald-50 text-emerald-700 rounded-xl p-2 text-center">
              Logged (Green): <span id="logged-users-count">0</span>
            </div>
            <div class="bg-amber-50 text-amber-700 rounded-xl p-2 text-center">
              Almost Finish (Yellow): <span id="almost-users-count">0</span>
            </div>
          </div>
          <div class="bg-blue-50 rounded-2xl p-2 border border-blue-100">
            <div id="nigeria-map-chart" class="w-full h-44 md:h-56"></div>
          </div>
        </div>
      </div>

      <!-- SCREEN: LOG FORM -->
      <div id="screen-log-form" class="app-screen p-6 space-y-6">
        <h1 class="text-2xl font-extrabold text-blue-900">Log Meetup Details</h1>
        <div class="stat-card p-4">
          <p class="text-xs font-black text-blue-500 uppercase tracking-widest">Log Details</p>
          <p class="text-xs text-slate-500 leading-relaxed mt-1">
            This information is encrypted and will be <strong>permanently deleted</strong> after you end your meetup safely.
          </p>
        </div>

        <form id="log-form" class="space-y-6 pb-20">
          <div class="space-y-2">
            <label for="log-package" class="block text-xs font-black text-blue-900 uppercase tracking-widest">Select Package *</label>
            <select id="log-package" required class="form-input">
              <option value="">Choose package...</option>
              <option value="Basic">Basic</option>
              <option value="Standard">Standard</option>
              <option value="Confidence Plus">Confidence Plus</option>
            </select>
            <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-widest">Payment is verified at log submission.</p>
            <div id="package-options" class="package-choices mt-2">
              <button type="button" class="package-pill" data-package="Basic">
                <p class="name">Basic</p>
                <p class="price">N500</p>
              </button>
              <button type="button" class="package-pill" data-package="Standard">
                <p class="name">Standard</p>
                <p class="price">N1,000</p>
              </button>
              <button type="button" class="package-pill" data-package="Confidence Plus">
                <p class="name">C Plus</p>
                <p class="price">N2,500</p>
              </button>
            </div>
            <div id="package-detail" class="package-detail">Select a package to preview what it includes.</div>
          </div>

          <div class="space-y-4">
            <h3 class="text-xs font-black text-blue-400 uppercase tracking-widest">The Stranger</h3>
            <div class="grid grid-cols-2 gap-4">
              <input type="text" id="fname" placeholder="First Name (Optional)" class="form-input">
              <input type="text" id="lname" placeholder="Last Name (Optional)" class="form-input">
            </div>

            <div id="phone-container" class="space-y-3">
              <input type="tel" maxlength="11" placeholder="Phone (Optional, 11 Digits)" inputmode="numeric"
                     oninput="this.value=this.value.replace(/\\D/g,'')" pattern="[0-9]{11}" minlength="11" class="form-input phone-entry">
            </div>

            <button type="button" id="btn-add-phone" class="text-xs font-black text-blue-500 flex items-center gap-1 uppercase tracking-widest">
              <i class="ph-bold ph-plus"></i> Add Another Phone
            </button>

            <input type="text" id="nickname" placeholder="Nickname (Optional)" class="form-input">
            <textarea id="friends" placeholder="Friends/Acquaintances (Optional)" rows="2" class="form-input"></textarea>
          </div>

          <div class="space-y-4 border-t border-blue-50 pt-4">
            <div class="flex justify-between items-center">
              <h3 class="text-xs font-black text-blue-400 uppercase tracking-widest">Meetup Location</h3>
            </div>

            <select id="place-type" required class="form-input">
              <option value="">Select a place type...</option>
              <option>Hotel</option><option>Home</option><option>Restaurant</option>
              <option>Office</option><option>Car</option><option>Public Space</option>
              <option>Other</option>
            </select>

            <textarea id="address" placeholder="Address / Location / Landmark *" rows="3" required class="form-input"></textarea>

            <div class="grid grid-cols-2 gap-4">
              <select id="state-select" required class="form-input"><option value="">State *</option></select>
              <select id="lga-select" disabled required class="form-input"><option value="">LGA *</option></select>
            </div>

            <button type="button" id="btn-gps" class="w-full text-[10px] bg-blue-50 text-blue-600 py-3 rounded-xl font-black uppercase tracking-widest border border-blue-100">
              <i class="ph-bold ph-map-pin"></i> Activate GPS (Standard Feature)
            </button>

            <p id="gps-status" class="hidden text-[11px] font-bold text-emerald-600 uppercase tracking-widest text-center"></p>
          </div>

          <div class="space-y-4 border-t border-blue-50 pt-4">
            <h3 class="text-xs font-black text-blue-400 uppercase tracking-widest">Supporting Evidence</h3>

            <div>
              <label class="block text-xs font-black text-blue-900 mb-2 uppercase tracking-widest">Image of Stranger (Optional)</label>
              <input id="img-stranger" type="file" accept="image/*" class="hidden">
              <button type="button" id="btn-img-stranger" class="file-input-label opacity-60">
                <i class="ph ph-image"></i> Choose File
              </button>
              <span id="fn-img-stranger" class="file-input-filename"></span>
            </div>

            <div>
              <label class="block text-xs font-black text-blue-900 mb-2 uppercase tracking-widest">Supporting Images (Optional)</label>
              <input id="img-support" type="file" accept="image/*" multiple class="hidden">
              <button type="button" id="btn-img-support" class="file-input-label opacity-60">
                <i class="ph ph-images"></i> Choose Files
              </button>
              <span id="fn-img-support" class="file-input-filename"></span>
            </div>

            <textarea id="info-extra" placeholder="Additional Details (Optional)" rows="2" class="form-input"></textarea>
          </div>

          <button id="btn-log-submit" type="submit" class="w-full btn-primary font-black py-5 rounded-2xl shadow-2xl uppercase tracking-widest">
            Start 48h Safety Watch
          </button>
        </form>
      </div>

      <!-- SCREEN: PROFILE -->
      <div id="screen-profile" class="app-screen p-6 space-y-6">
        <h1 class="text-2xl font-extrabold text-blue-900">Profile</h1>
        <div class="stat-card p-5 space-y-2">
          <p class="text-xs font-black text-blue-400 uppercase tracking-widest">Signed-In User</p>
          <p id="profile-user-name" class="text-sm text-slate-700">Name: -</p>
          <p id="profile-user-phone" class="text-sm text-slate-700">Phone: -</p>
        </div>
        <form id="profile-form" class="space-y-4">
          <div class="stat-card p-5 space-y-4">
            <h2 class="text-xs font-black text-blue-400 uppercase tracking-widest">Emergency Setup</h2>
            <input type="text" id="fpc-name" placeholder="FPC Name (First Person to Contact)" class="form-input" required>
            <input type="tel" id="fpc-phone" placeholder="FPC Phone (11 digits)" maxlength="11" minlength="11"
                   inputmode="numeric" pattern="[0-9]{11}" oninput="this.value=this.value.replace(/\\D/g,'')" class="form-input" required>
            <select id="fpc-relation" class="form-input" required>
              <option value="">Relationship with FPC *</option>
              <option>Friend</option>
              <option>Sister</option>
              <option>Brother</option>
              <option>Acquitance</option>
              <option>Mentor</option>
              <option>Classmate</option>
              <option>Business Partner</option>
              <option>Father</option>
              <option>Mother</option>
              <option>Wife</option>
              <option>Husband</option>
              <option>Relative</option>
              <option>Uncle</option>
              <option>Aunty</option>
            </select>
            <select id="fpc-priority" class="form-input" required>
              <option value="">Emergency Priority *</option>
              <option value="person_then_police">Person first, then Police</option>
              <option value="police_then_person">Police first, then Person</option>
            </select>
          </div>
          <button type="submit" class="w-full btn-primary font-black py-4 rounded-2xl shadow-2xl uppercase tracking-widest">
            Save Profile
          </button>
        </form>
        <div class="stat-card p-6">
          <p class="text-xs font-black text-blue-400 uppercase tracking-widest">Saved FPC</p>
          <p id="fpc-summary" class="text-sm text-slate-600 mt-2">No emergency contact saved yet.</p>
        </div>
        <button id="btn-logout" type="button" class="w-full bg-rose-50 text-rose-600 border border-rose-200 py-4 rounded-2xl font-black uppercase tracking-widest">
          Logout
        </button>
      </div>

      <!-- SCREEN: ACTIVE -->
      <div id="screen-active" class="app-screen p-6 space-y-8">
        <div class="text-center space-y-4 pt-12">
          <p class="text-blue-500 font-black uppercase tracking-[0.4em] text-[10px]">Guardian Watch Active</p>
          <h1 id="timer" class="text-7xl font-black tracking-tighter text-blue-900 tabular-nums">48:00:00</h1>
          <div class="w-48 h-2 bg-blue-50 mx-auto rounded-full overflow-hidden">
            <div class="h-full bg-blue-600 w-full animate-pulse"></div>
          </div>
        </div>

        <div class="space-y-4 pt-10">
          <button id="btn-end-meetup" class="w-full bg-blue-900 text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-2xl">
            Verify to End Meetup
          </button>

          <div class="stat-card p-6 border-t-4 border-blue-500">
            <h3 class="text-xs font-black text-blue-900 uppercase tracking-[0.2em] mb-4">Current Protection</h3>
            <p id="protection-text" class="text-sm text-slate-500 leading-relaxed italic">
              The "Meetily Basic" switch is active. We will notify the authorities if you don't verify by the deadline.
            </p>
          </div>

          <div class="stat-card p-6 space-y-4">
            <h3 class="text-xs font-black text-blue-900 uppercase tracking-[0.2em]">Meetup Details</h3>
            <div id="active-meetup-details" class="text-xs text-slate-600 leading-relaxed">No active meetup.</div>
            <textarea id="meetup-update-input" rows="2" class="form-input" placeholder="Add update note"></textarea>
            <button id="btn-add-update" type="button" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-black uppercase tracking-widest text-xs">
              Add Update
            </button>
            <div id="meetup-updates-list" class="space-y-2 text-xs text-slate-600"></div>
          </div>
        </div>
      </div>

      <!-- MODAL: UPGRADE -->
      <div id="modal-upgrade" class="hidden fixed inset-0 bg-blue-900/40 backdrop-blur-md z-[110] flex items-center justify-center p-6">
        <div class="bg-white rounded-[2.5rem] w-full max-w-sm p-8 space-y-8 shadow-2xl">
          <div class="w-20 h-20 bg-blue-100 rounded-3xl flex items-center justify-center mx-auto text-blue-600 shadow-inner">
            <i class="ph-bold ph-lightning text-5xl"></i>
          </div>
          <div class="text-center space-y-2">
            <h2 class="text-2xl font-black text-blue-900">Upgrade Required</h2>
            <p id="upgrade-desc" class="text-sm text-slate-500 italic">This feature is premium only.</p>
          </div>

          <div class="bg-blue-50 p-6 rounded-3xl border border-blue-100">
            <p class="text-[10px] font-black uppercase text-blue-400 tracking-widest mb-3">Transfer to Upgrade</p>
            <p class="text-xs font-bold text-blue-900">Name: <span class="font-black">Meetily</span></p>
            <p class="text-xs font-bold text-blue-900 mt-1">Bank: <span class="font-black">Stanbic IBTC</span></p>
            <p class="text-2xl font-black text-blue-600 mt-2">5770901212</p>
          </div>

          <div class="grid gap-3">
            <div class="rounded-2xl border border-blue-100 p-4 bg-white">
              <p class="text-[10px] font-black uppercase tracking-widest text-blue-400">Packages</p>
              <ul class="mt-2 text-xs text-slate-600 space-y-1">
                <li><span class="font-black text-blue-900">Basic (₦500):</span> Just log basic stranger details</li>
                <li><span class="font-black text-blue-900">Standard (₦1,000):</span> Basic + GPS</li>
                <li><span class="font-black text-blue-900">Confidence Plus (₦2,500):</span> Basic + GPS + Pictures</li>
              </ul>
            </div>

            <div class="flex gap-4">
              <button type="button" id="btn-upgrade-later" class="flex-1 text-slate-400 font-bold py-3 text-xs uppercase tracking-widest">Later</button>
              <button type="button" id="btn-upgrade-paid" class="flex-1 btn-primary py-4 rounded-2xl font-black text-xs uppercase tracking-widest">I've Paid</button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL: PAYMENT WAIT -->
      <div id="modal-payment" class="hidden fixed inset-0 bg-blue-900/50 backdrop-blur-md z-[114] flex items-center justify-center p-6">
        <div class="bg-white rounded-[2.3rem] w-full max-w-sm p-8 space-y-6 shadow-2xl">
          <div class="text-center space-y-2">
            <h2 class="text-2xl font-black text-blue-900">Complete Payment</h2>
            <p class="text-sm text-slate-500">Transfer to this virtual account. Logging unlocks automatically once paid.</p>
          </div>
          <div class="bg-blue-50 border border-blue-100 rounded-3xl p-5 text-center space-y-2">
            <p class="text-[10px] text-blue-400 font-black uppercase tracking-widest">Virtual Account Number</p>
            <p id="payment-account-number" class="text-3xl text-blue-700 font-black tracking-wide">-</p>
          </div>
            <p id="payment-status-text" class="text-xs text-slate-500 text-center font-bold uppercase tracking-widest">Waiting for payment confirmation...</p>
            <p id="payment-required-package" class="text-[10px] text-blue-500 text-center font-black uppercase tracking-widest">Required plan: -</p>
          <div class="grid grid-cols-2 gap-3">
            <button type="button" id="btn-payment-refresh" class="btn-primary py-3 rounded-xl font-black uppercase tracking-widest text-xs">Check Now</button>
            <button type="button" id="btn-payment-close" class="text-slate-400 font-bold py-3 text-xs uppercase tracking-widest">Close</button>
          </div>
        </div>
      </div>

      <!-- MODAL: LIVENESS -->
      <div id="modal-verify" class="hidden fixed inset-0 bg-white/95 backdrop-blur-2xl z-[120] flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center space-y-10">
          <div class="space-y-2">
            <h2 class="text-3xl font-black text-blue-900">Security Check</h2>
            <p class="text-sm text-slate-500">Complete facial expression steps first, then capture for comparison.</p>
          </div>
          <div class="w-72 h-72 mx-auto bg-slate-100 rounded-full border-8 border-blue-50 overflow-hidden relative shadow-[0_20px_50px_rgba(14,165,233,0.3)]">
            <video id="webcam" autoplay muted playsinline class="w-full h-full object-cover scale-x-[-1]"></video>
            <div class="scan-line"></div>
          </div>
          <canvas id="verify-canvas" class="hidden"></canvas>
          <p id="verify-step" class="text-[11px] font-black text-blue-500 uppercase tracking-[0.18em]">Expression step pending</p>
          <p id="verify-status" class="text-sm font-black text-blue-600 uppercase tracking-[0.2em]">Ready to verify</p>
          <div class="flex justify-center gap-4">
            <button type="button" id="btn-verify-capture" class="btn-primary px-6 py-3 rounded-xl font-black uppercase tracking-widest text-xs hidden">Capture & Verify</button>
            <button type="button" id="btn-cancel-verify" class="text-rose-500 font-black uppercase tracking-widest text-xs">Abort & Return</button>
          </div>
        </div>
      </div>

      <!-- MODAL: PRE-LOG PHOTO -->
      <div id="modal-prelog-photo" class="hidden fixed inset-0 bg-white/95 backdrop-blur-2xl z-[115] flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center space-y-8">
          <div class="space-y-2">
            <h2 class="text-2xl font-black text-blue-900">Pre-Log Face Capture</h2>
            <p class="text-sm text-slate-500">Capture your photo before saving this meetup log.</p>
          </div>
          <div class="w-72 h-72 mx-auto bg-slate-100 rounded-full border-8 border-blue-50 overflow-hidden shadow-[0_20px_50px_rgba(14,165,233,0.3)]">
            <video id="prelog-webcam" autoplay muted playsinline class="w-full h-full object-cover scale-x-[-1]"></video>
          </div>
          <canvas id="prelog-canvas" class="hidden"></canvas>
          <p id="prelog-status" class="text-sm font-black text-blue-600 uppercase tracking-[0.2em]">Camera ready</p>
          <div class="flex justify-center gap-4">
            <button type="button" id="btn-capture-prelog" class="btn-primary px-6 py-3 rounded-xl font-black uppercase tracking-widest text-xs">Capture & Save Log</button>
            <button type="button" id="btn-cancel-prelog" class="text-rose-500 font-black uppercase tracking-widest text-xs">Cancel</button>
          </div>
        </div>
      </div>

      <!-- FIXED BOTTOM NAV -->
      <nav id="app-nav" class="hidden h-20 bg-white border-t border-blue-50 fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md flex items-center justify-around px-8 z-[80]">
        <button type="button" data-screen="screen-home" class="nav-btn-el active nav-item flex flex-col items-center gap-1">
          <i class="ph-bold ph-house text-2xl"></i>
          <span class="text-[9px] font-black uppercase">Home</span>
        </button>

        <button type="button" id="nav-log" class="nav-btn-el nav-item flex flex-col items-center gap-1">
          <div class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center -mt-12 shadow-2xl border-4 border-white transition-all active:scale-90">
            <i class="ph-bold ph-shield-check text-2xl"></i>
          </div>
          <span class="text-[9px] font-black uppercase mt-1">Log</span>
        </button>

        <button type="button" data-screen="screen-profile" class="nav-btn-el nav-item flex flex-col items-center gap-1">
          <i class="ph-bold ph-user-circle text-2xl"></i>
          <span class="text-[9px] font-black uppercase">Profile</span>
        </button>
      </nav>

    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const ALL_STATES = [
        "Abia", "Adamawa", "Akwa Ibom", "Anambra", "Bauchi", "Bayelsa", "Benue", "Borno",
        "Cross River", "Delta", "Ebonyi", "Edo", "Ekiti", "Enugu", "Federal Capital Territory",
        "Gombe", "Imo", "Jigawa", "Kaduna", "Kano", "Katsina", "Kebbi", "Kogi", "Kwara",
        "Lagos", "Nasarawa", "Niger", "Ogun", "Ondo", "Osun", "Oyo", "Plateau", "Rivers",
        "Sokoto", "Taraba", "Yobe", "Zamfara"
      ];

      let nigeriaData = {
        "Abia": ["Aba North","Aba South","Umuahia North"],
        "Adamawa": ["Yola North","Yola South"],
        "Akwa Ibom": ["Uyo","Eket"],
        "Anambra": ["Awka South","Onitsha"],
        "Lagos": ["Ikeja","Alimosho","Lekki","Surulere"],
        "Kaduna": ["Kaduna North","Kaduna South"],
        "Borno": ["Maiduguri","Jere"],
        "Federal Capital Territory": ["AMAC","Bwari"]
      };

      const socialProofEvents = [
        "User in Kaduna just verified safely.",
        "Tunde in Lagos just started a log.",
        "Jessica in Abuja logged a meetup.",
        "A traveler in Maiduguri is protected."
      ];
      const LANDING_HERO_IMAGES = [
        "https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?auto=format&fit=crop&q=80&w=1200",
        "https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&q=80&w=1200",
        "https://images.unsplash.com/photo-1529236183275-4fdcf2bc987e?auto=format&fit=crop&q=80&w=1200",
        "https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?auto=format&fit=crop&q=80&w=1200",
        "https://images.unsplash.com/photo-1521791136064-7986c2920216?auto=format&fit=crop&q=80&w=1200",
        "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&q=80&w=1200",
        "https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&q=80&w=1200",
        "https://images.unsplash.com/photo-1515169067868-5387ec356754?auto=format&fit=crop&q=80&w=1200"
      ];
      const LANDING_HERO_HEADLINES = [
        "Meetily Log Meetups."
      ];
      const LANDING_HERO_BADGES = [
        "Verified Secure Logging",
        "She thought it was love. She never came back.",
        "Chidere went out to hustle. No trace till today.",
        "Nancy left for a business meeting. Family waited for months.",
        "Silence after meetup is not normal.",
        "One log can change the ending.",
        "Delay is dangerous. Log it now.",
        "Meetily keeps the trail when stories go dark."
      ];
      const TESTIMONIALS = [
        {
          quote: "\"As a frequent solo business traveler, Meetily is a non-negotiable part of my routine. It gives my family incredible peace of mind. I feel so much safer.\"",
          name: "Jessica S.",
          role: "Consultant",
          avatar: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&q=80&w=150",
          borderClass: "border-blue-500",
          accentClass: "text-blue-400"
        },
        {
          quote: "\"I used this on my backpacking trip. Knowing my parents had a way to trace my steps was comforting. Clean and super intuitive.\"",
          name: "Mike T.",
          role: "Adventurer",
          avatar: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&q=80&w=150",
          borderClass: "border-cyan-400",
          accentClass: "text-cyan-500"
        },
        {
          quote: "\"The interface is super intuitive. It takes less than 30 seconds to log my stay. A brilliant and much-needed tool.\"",
          name: "Anna C.",
          role: "Digital Nomad",
          avatar: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?auto=format&fit=crop&q=80&w=150",
          borderClass: "border-indigo-400",
          accentClass: "text-indigo-500"
        }
      ];

      // Package rules (NO upfront selection)
      // Basic = details only
      // Standard = + GPS
      // Confidence Plus = + GPS + pictures
      const PACKAGE_RANK = { "Basic": 1, "Standard": 2, "Confidence Plus": 3 };

      let unlockedPackage = "Basic"; // start Basic (change after "I've Paid")
      let pendingUpgradeTarget = null;

      let currentActive = null;
      let timerInt = null;
      let gpsLogInterval = null;
      const SCREEN_DURATION = 48 * 60 * 60 * 1000;
      const GPS_LOG_INTERVAL_MS = 10 * 60 * 1000;
      let preLogImageDataUrl = "";
      let pendingMeetupData = null;
      let simulatedUsers = [];
      let usersPulseInt = null;
      let mapRoot = null;
      let polygonSeries = null;
      let dotSeries = null;
      let stateGeometryPool = [];
      let signedInUser = { name: "", phone: "", isPaid: false, package: "Basic", virtualAccountNumber: "", paidTotal: 0 };
      let livenessStepIndex = 0;
      let livenessAutoTimer = null;
      let faceModelsLoaded = false;
      let livenessSession = null;
      let cameraPermissionState = "prompt";
      let isAuthSubmitting = false;
      let isLogSubmitting = false;
      let isPrelogCaptureBusy = false;
      let paymentPollInterval = null;
      let requiredPaymentPackage = null;
      let simulatedYellowRatio = 0.12;
      const LIVENESS_STEPS = [
        "Smile clearly at the camera",
        "Turn your face slightly left",
        "Turn your face slightly right"
      ];

      // Social proof controller
      let toastInterval = null;
      let toastVisibleTimeout = null;
      let landingHeroIndex = 0;
      let landingHeroInterval = null;
      let testimonialIndex = 0;
      let testimonialInterval = null;
      const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzboXGuLe0DPfUYiU361naINfQ1h-6SprS83THOPwRVqUMOTQW6MtgSb6dpoDr49omt/exec";
      const PEYGO_API = "https://peygo.net/_functions";
      const PACKAGE_MIN_PAYMENT = { "Basic": 500, "Standard": 1000, "Confidence Plus": 2500 };
      const PACKAGE_META = {
        "Basic": "Best for quick logging. Includes stranger details only (no live GPS, no image evidence).",
        "Standard": "Adds live GPS tracking during your active meetup. Recommended for most users.",
        "Confidence Plus": "Full safety mode: live GPS + image evidence uploads for stronger records."
      };

      const stateSel = document.getElementById('state-select');
      const lgaSel = document.getElementById('lga-select');

      function sanitizeDigitsOnly(input) {
        input.value = input.value.replace(/\D/g, '');
      }

      function normalizePhone(value) {
        return String(value || "").replace(/\D/g, "").trim();
      }

      function normalizeLocalPhone(value) {
        const digits = normalizePhone(value);
        if (!digits) return "";
        if (digits.length === 10) return `0${digits}`;
        if (digits.length === 11 && digits.startsWith("0")) return digits;
        if (digits.length === 13 && digits.startsWith("234")) return `0${digits.slice(-10)}`;
        if (digits.length > 11) return `0${digits.slice(-10)}`;
        return digits;
      }

      function paymentPhoneCandidates(value) {
        const digits = normalizePhone(value);
        const set = new Set();
        if (!digits) return [];
        set.add(digits);
        if (digits.length === 11 && digits.startsWith("0")) {
          set.add(digits.slice(1)); // 903...
          set.add(`234${digits.slice(1)}`); // 234903...
        }
        if (digits.length === 10) {
          set.add(`0${digits}`);
          set.add(`234${digits}`);
        }
        if (digits.length === 13 && digits.startsWith("234")) {
          set.add(`0${digits.slice(-10)}`);
          set.add(digits.slice(-10));
        }
        return Array.from(set);
      }

      function phoneKey(value) {
        const digits = normalizePhone(value);
        if (!digits) return "";
        if (digits.length > 10) return digits.slice(-10);
        return digits;
      }

      function normalizePin(value) {
        return String(value || "").replace(/\D/g, "").trim();
      }

      function refreshPaymentUi() {
        // Home payment pill removed; keep function as no-op for existing calls.
      }

      function syncPackageOptionCards() {
        const selected = document.getElementById('log-package')?.value || "";
        document.querySelectorAll('#package-options .package-pill').forEach((el) => {
          el.classList.toggle('active', el.dataset.package === selected);
        });
        const detail = document.getElementById('package-detail');
        if (detail) detail.innerText = PACKAGE_META[selected] || "Select a package to preview what it includes.";
      }

      function setSelectedPackage(pkg) {
        const pkgEl = document.getElementById('log-package');
        if (!pkgEl) return;
        pkgEl.value = pkg;
        removeFieldError(pkgEl);
        syncPackageOptionCards();
      }

      function extractNumber(value) {
        const n = Number(value);
        return Number.isFinite(n) ? n : 0;
      }

      function highestPackageFromAmount(totalPaid) {
        const amount = extractNumber(totalPaid);
        if (amount >= PACKAGE_MIN_PAYMENT["Confidence Plus"]) return "Confidence Plus";
        if (amount >= PACKAGE_MIN_PAYMENT["Standard"]) return "Standard";
        if (amount >= PACKAGE_MIN_PAYMENT["Basic"]) return "Basic";
        return "Basic";
      }

      function rankOfPackage(pkg) {
        return PACKAGE_RANK[pkg] || 0;
      }

      function normalizePaymentStatus(resp, fallbackPackage) {
        const user = resp?.user || {};
        const directTotals = [
          resp?.totalPaid, resp?.total_paid, resp?.amountPaid, resp?.amount_paid,
          resp?.totalAmount, resp?.total_amount, resp?.paidTotal, resp?.paid_total,
          resp?.lastPaymentAmount, resp?.last_payment_amount,
          user?.totalPaid, user?.total_paid, user?.amountPaid, user?.amount_paid,
          user?.totalAmount, user?.total_amount, user?.paidTotal, user?.paid_total,
          user?.lastPaymentAmount, user?.last_payment_amount
        ].map(extractNumber);
        let totalPaid = Math.max(0, ...directTotals);

        const payments = Array.isArray(resp?.payments) ? resp.payments : (Array.isArray(user?.payments) ? user.payments : []);
        if (payments.length) {
          const sum = payments.reduce((acc, p) => {
            return acc + extractNumber(p?.amount ?? p?.paidAmount ?? p?.value ?? p?.total);
          }, 0);
          if (sum > totalPaid) totalPaid = sum;
        }

        const packageFromAmount = highestPackageFromAmount(totalPaid);
        const packageFromResp = resp?.package || user?.package || fallbackPackage || "Basic";
        const normalizedPackage = rankOfPackage(packageFromAmount) >= rankOfPackage(packageFromResp)
          ? packageFromAmount
          : packageFromResp;

        const isPaid = !!(resp?.isPaid || user?.isPaid || totalPaid >= PACKAGE_MIN_PAYMENT["Basic"]);
        return {
          isPaid,
          package: normalizedPackage || "Basic",
          paidTotal: totalPaid,
          virtualAccountNumber: user?.virtualAccountNumber || resp?.virtualAccountNumber || ""
        };
      }

      function setButtonLoading(button, isLoading, loadingLabel) {
        if (!button) return;
        if (!button.dataset.defaultLabel) button.dataset.defaultLabel = button.innerText;
        button.disabled = !!isLoading;
        if (isLoading) {
          button.innerHTML = `<span class="btn-spinner"></span>${loadingLabel || "Processing..."}`;
          return;
        }
        button.innerText = button.dataset.defaultLabel;
      }

      function setAuthModeUi(isSignup) {
        const title = document.getElementById('auth-title');
        const subtitle = document.getElementById('auth-subtitle');
        const signup = document.getElementById('signup-fields');
        const toggle = document.getElementById('btn-toggle-auth');
        const submitBtn = document.getElementById('auth-submit-btn');
        title.innerText = isSignup ? 'Sign Up' : 'Welcome Back';
        subtitle.innerText = isSignup ? 'Enter your details to proceed.' : 'Sign in with your phone and PIN.';
        signup.style.display = isSignup ? 'block' : 'none';
        toggle.innerText = isSignup ? 'Already have an account? Sign In' : "Don't have an account? Sign Up";
        submitBtn.dataset.defaultLabel = isSignup ? 'Create Account' : 'Sign In';
        submitBtn.innerText = submitBtn.dataset.defaultLabel;
      }

      async function peygoSignup(name, phone, pin) {
        const res = await fetch(`${PEYGO_API}/apiSafeMeetSignup`, {
          method: "POST",
          body: JSON.stringify({ name, phone, pin })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || String(data?.status || "").toLowerCase() !== "success") {
          throw new Error(data?.message || "Signup failed");
        }
        return data;
      }

      async function checkPaymentStatus(phone, pin) {
        const candidates = paymentPhoneCandidates(phone);
        let lastErr = null;
        for (const p of candidates) {
          const query = new URLSearchParams({ phone: p });
          if (pin) query.set("pin", normalizePin(pin));
          const ctl = new AbortController();
          const t = setTimeout(() => ctl.abort(), 7000);
          const res = await fetch(`${PEYGO_API}/apiSafeMeetStatus?${query.toString()}`, {
            cache: "no-store",
            signal: ctl.signal
          }).finally(() => clearTimeout(t));
          const data = await res.json().catch(() => ({}));
          if (res.ok) return data;
          if (res.status === 404) {
            lastErr = new Error("Payment status endpoint not found (404)");
            continue;
          }
          lastErr = new Error(data?.message || "Unable to verify payment");
        }
        throw lastErr || new Error("Unable to verify payment");
      }

      function stopPaymentPolling() {
        if (paymentPollInterval) clearInterval(paymentPollInterval);
        paymentPollInterval = null;
      }

      function closePaymentModal() {
        document.getElementById('modal-payment').classList.add('hidden');
      }

      function packageCovers(currentPackage, requiredPackage) {
        const currentRank = PACKAGE_RANK[currentPackage] || 0;
        const requiredRank = PACKAGE_RANK[requiredPackage] || 0;
        return currentRank >= requiredRank;
      }

      function openPaymentModal(accountNumber, requiredPackage) {
        requiredPaymentPackage = requiredPackage || requiredPaymentPackage || "Basic";
        document.getElementById('payment-account-number').innerText = accountNumber || "-";
        document.getElementById('payment-status-text').innerText = "Waiting for payment confirmation...";
        document.getElementById('payment-required-package').innerText = `Required plan: ${requiredPaymentPackage}`;
        document.getElementById('modal-payment').classList.remove('hidden');
      }

      async function verifyPaymentNow() {
        const statusEl = document.getElementById('payment-status-text');
        try {
          statusEl.innerText = "Checking payment status...";
          const resp = await checkPaymentStatus(signedInUser.phone || "", "");
          const normalized = normalizePaymentStatus(resp, signedInUser.package || "Basic");
          signedInUser.isPaid = normalized.isPaid;
          signedInUser.package = normalized.package;
          signedInUser.paidTotal = normalized.paidTotal;
          signedInUser.virtualAccountNumber = normalized.virtualAccountNumber || signedInUser.virtualAccountNumber || "";
          unlockedPackage = signedInUser.package;
          refreshPaymentUi();
          try {
            await updateUserInDb(signedInUser.phone, {
              phone_key: phoneKey(signedInUser.phone),
              package: signedInUser.package,
              is_paid: signedInUser.isPaid,
              paid_total: signedInUser.paidTotal,
              virtual_account_number: signedInUser.virtualAccountNumber
            });
          } catch (_) {
            // non-blocking
          }
          if (signedInUser.isPaid) {
            if (!packageCovers(signedInUser.package, requiredPaymentPackage || "Basic")) {
              statusEl.innerText = `Paid total ₦${signedInUser.paidTotal.toLocaleString()}. Current plan ${signedInUser.package}; required ${requiredPaymentPackage || "Basic"}.`;
              return false;
            }
            stopPaymentPolling();
            statusEl.innerText = `Payment confirmed. Plan: ${signedInUser.package}.`;
            closePaymentModal();
            requiredPaymentPackage = null;
            return true;
          }
          statusEl.innerText = "Not paid yet. We will keep checking every 5 seconds.";
          return false;
        } catch (_) {
          stopPaymentPolling();
          statusEl.innerText = "Payment check service unavailable. Tap Check Now after backend is fixed.";
          return false;
        }
      }

      function startPaymentPolling() {
        stopPaymentPolling();
        paymentPollInterval = setInterval(verifyPaymentNow, 5000);
      }

      function finalizeSigninUi() {
        updateProfileUserDetails();
        refreshPaymentUi();
        document.getElementById('app-nav').classList.remove('hidden');
        document.getElementById('user-info-reveal').classList.remove('hidden');
        showScreen('screen-home');
        startUsersMapPulse();
        restoreActiveMeetupForUser().catch(() => {});
      }

      function logout() {
        stopPaymentPolling();
        closePaymentModal();
        closeUpgradeModal();
        closePreLogModal();
        closeVerifyModal();
        clearInterval(timerInt);
        timerInt = null;
        stopGPSLogging();
        currentActive = null;
        pendingMeetupData = null;
        preLogImageDataUrl = "";
        requiredPaymentPackage = null;
        unlockedPackage = "Basic";
        signedInUser = { name: "", phone: "", isPaid: false, package: "Basic", virtualAccountNumber: "", paidTotal: 0 };
        document.getElementById('app-nav').classList.add('hidden');
        document.getElementById('user-info-reveal').classList.add('hidden');
        document.getElementById('active-meetup-card-home').classList.add('hidden');
        document.getElementById('no-active-meetup').classList.remove('hidden');
        document.getElementById('meetup-update-input').value = "";
        document.getElementById('auth-form').reset();
        updateProfileUserDetails();
        refreshPaymentUi();
        renderMeetupDetails();
        showScreen('screen-landing');
      }

      function armActionButtonLocks() {
        const actionIds = [
          "btn-home-log", "btn-add-phone", "btn-gps", "btn-img-stranger", "btn-img-support",
          "btn-upgrade-paid", "btn-payment-refresh", "btn-add-update", "btn-end-meetup",
          "btn-verify-capture", "btn-capture-prelog", "btn-log-submit", "auth-submit-btn"
        ];
        actionIds.forEach((id) => {
          const btn = document.getElementById(id);
          if (!btn) return;
          btn.addEventListener('click', (e) => {
            if (btn.disabled) return;
            if (btn.dataset.locked === "1") {
              e.preventDefault();
              e.stopImmediatePropagation();
              return;
            }
            btn.dataset.locked = "1";
            btn.classList.add('opacity-80');
            setTimeout(() => {
              btn.dataset.locked = "0";
              btn.classList.remove('opacity-80');
            }, 900);
          }, true);
        });
      }

      function normalizeKey(key) {
        return String(key || "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "_")
          .replace(/[^a-z0-9_]/g, "_")
          .replace(/_+/g, "_")
          .replace(/^_+|_+$/g, "");
      }

      function extractDynamicFormData(formEl) {
        const out = {};
        formEl.querySelectorAll('input, select, textarea').forEach((el) => {
          if (!el.id && !el.name) return;
          if (el.type === "button" || el.type === "submit" || el.type === "reset") return;
          const rawKey = el.name || el.id;
          const key = normalizeKey(rawKey);
          if (!key) return;

          if (el.type === "file") {
            const files = el.files ? Array.from(el.files).map((f) => f.name) : [];
            out[key] = el.multiple ? files : (files[0] || "");
            return;
          }
          if ((el.type === "checkbox" || el.type === "radio")) {
            out[key] = !!el.checked;
            return;
          }
          out[key] = typeof el.value === "string" ? el.value.trim() : el.value;
        });
        return out;
      }

      async function sendToBackend(payload) {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        let json = {};
        try { json = text ? JSON.parse(text) : {}; } catch (_) { json = { raw: text }; }
        if (!res.ok || (json.status && String(json.status).toLowerCase() !== "success")) {
          throw new Error(json.message || "Backend request failed");
        }
        return json;
      }

      function safeGetCreatedId(resp) {
        return resp?.id || resp?.data?.id || resp?.data?.[0]?.id || "";
      }

      function extractRows(resp) {
        if (Array.isArray(resp?.data)) return resp.data;
        if (Array.isArray(resp?.rows)) return resp.rows;
        if (Array.isArray(resp?.result)) return resp.result;
        if (Array.isArray(resp?.data?.rows)) return resp.data.rows;
        return [];
      }

      function findUserByPhone(rows, phone) {
        const targetPhone = phoneKey(phone);
        return rows.find((u) => phoneKey(u?.phone) === targetPhone) || null;
      }

      function findUserByPhoneAndPin(rows, phone, pin) {
        const targetPhone = phoneKey(phone);
        const targetPin = normalizePin(pin);
        return rows.find((u) => phoneKey(u?.phone) === targetPhone && normalizePin(u?.pin) === targetPin) || null;
      }

      async function readUsersByPhone(phone) {
        // Single backend call to avoid lock contention in Apps Script.
        const all = await sendToBackend({
          action: "read",
          sheet: "Users"
        });
        const allRows = extractRows(all);
        const target = phoneKey(phone);
        const matched = allRows.filter((u) => phoneKey(u?.phone) === target);
        return { status: "success", data: matched };
      }

      async function createUserInDb(data, options = {}) {
        const skipExistsCheck = !!options.skipExistsCheck;
        if (!skipExistsCheck) {
          const existingResp = await readUsersByPhone(data?.phone || "");
          const existing = findUserByPhone(extractRows(existingResp), data?.phone || "");
          if (existing) return { status: "exists", data: existing };
        }
        return sendToBackend({
          action: "create",
          sheet: "Users",
          data
        });
      }

      async function updateUserInDb(phone, data) {
        if (!normalizePhone(phone)) return { status: "skipped" };
        const key = phoneKey(phone);
        const byKey = await sendToBackend({
          action: "update",
          sheet: "Users",
          filters: { phone_key: key },
          data
        }).catch(() => null);
        if (byKey && extractNumber(byKey.updated) > 0) return byKey;
        return sendToBackend({
          action: "update",
          sheet: "Users",
          filters: { phone },
          data
        });
      }

      function parseJsonSafe(value, fallback) {
        try {
          return value ? JSON.parse(value) : fallback;
        } catch (_) {
          return fallback;
        }
      }

      function parseGpsText(value) {
        const txt = String(value || "");
        const parts = txt.split(",").map((p) => Number(String(p).trim()));
        if (parts.length !== 2 || !Number.isFinite(parts[0]) || !Number.isFinite(parts[1])) return null;
        return { latitude: parts[0], longitude: parts[1] };
      }

      async function restoreActiveMeetupForUser() {
        try {
          let rows = [];
          try {
            const resp = await sendToBackend({
              action: "read",
              sheet: "Meetups",
              filters: { user_phone: signedInUser.phone, status: "ACTIVE_WATCH" }
            });
            rows = extractRows(resp);
          } catch (_) {
            rows = [];
          }
          if (!rows.length) {
            const respAll = await sendToBackend({
              action: "read",
              sheet: "Meetups"
            });
            const allRows = extractRows(respAll);
            rows = allRows.filter((r) => {
              return String(r.status || "") === "ACTIVE_WATCH" && phoneKey(r.user_phone) === phoneKey(signedInUser.phone);
            });
          }
          if (!rows.length) {
            currentActive = null;
            document.getElementById('active-meetup-card-home').classList.add('hidden');
            document.getElementById('no-active-meetup').classList.remove('hidden');
            renderMeetupDetails();
            return;
          }
          const latest = rows.sort((a, b) => {
            const ta = new Date(a.started_at || 0).getTime();
            const tb = new Date(b.started_at || 0).getTime();
            return tb - ta;
          })[0];
          const startedAtMs = new Date(latest.started_at || Date.now()).getTime();
          const gpsPoint = parseGpsText(latest.last_gps || "");
          const gpsLogs = [];
          if (gpsPoint) {
            gpsLogs.push({
              reason: "restored_last_gps",
              timestamp: latest.last_gps_at || latest.updated_at || latest.started_at || new Date().toISOString(),
              latitude: gpsPoint.latitude,
              longitude: gpsPoint.longitude
            });
          }
          const updates = [];
          if (latest.last_update_note) {
            updates.push({
              note: String(latest.last_update_note),
              time: latest.last_update_at ? new Date(latest.last_update_at).toLocaleString() : "Earlier"
            });
          }
          const details = {
            fullName: latest.full_name || latest.stranger_name || latest.name || "",
            phones: parseJsonSafe(latest.phones_json, []),
            placeType: latest.place_type || "",
            address: latest.address || "",
            state: latest.state || "",
            lga: latest.lga || "",
            selectedPackage: latest.selected_package || "Basic",
            strangerImageDataUrls: parseJsonSafe(latest.stranger_images_json, []),
            supportImageDataUrls: parseJsonSafe(latest.support_images_json, [])
          };
          currentActive = {
            start: Number.isFinite(startedAtMs) ? startedAtMs : Date.now(),
            pkg: latest.selected_package || signedInUser.package || "Basic",
            meetupId: latest.id || `local_${Date.now()}`,
            preLogPhoto: latest.prelog_photo || "",
            gpsLogs,
            details,
            updates
          };
          document.getElementById('active-meetup-card-home').classList.remove('hidden');
          document.getElementById('no-active-meetup').classList.add('hidden');
          document.getElementById('protection-text').innerText =
            `The "Meetily ${currentActive.pkg}" switch is active. We will notify the authorities if you don't verify by the deadline.`;
          renderActiveMeetupHomeCard();
          renderMeetupDetails();
          startTimer();
        } catch (_) {
          // Keep UI usable even if restore fails
        }
      }

      async function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(String(reader.result || ""));
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async function filesToDataUrls(files) {
        return Promise.all(files.map((f) => fileToDataUrl(f)));
      }

      function removeFieldError(input) {
        if (!input) return;
        input.classList.remove('input-error');
        const next = input.nextElementSibling;
        if (next && next.classList.contains('field-error')) next.remove();
      }

      function setFieldError(input, message) {
        if (!input) return;
        removeFieldError(input);
        input.classList.add('input-error');
        const err = document.createElement('p');
        err.className = 'field-error';
        err.innerText = message;
        input.insertAdjacentElement('afterend', err);
      }

      function validateRequired(input, message) {
        removeFieldError(input);
        const value = (input.value || '').trim();
        if (!value) {
          setFieldError(input, message);
          return false;
        }
        return true;
      }

      function validatePhoneIfPresent(input, required = false) {
        removeFieldError(input);
        sanitizeDigitsOnly(input);
        if (!input.value && !required) return true;
        if (!input.value && required) {
          setFieldError(input, "Phone number is required");
          return false;
        }
        if (input.value.length !== 11) {
          setFieldError(input, "Phone must be exactly 11 digits");
          return false;
        }
        return true;
      }

      function validateAuthForm() {
        const isSignup = document.getElementById('auth-title').innerText === 'Sign Up';
        let valid = true;
        const name = document.getElementById('auth-name');
        const phone = document.getElementById('auth-phone');
        const pin = document.getElementById('auth-pin');
        if (isSignup) valid = validateRequired(name, "Full name is required") && valid;
        valid = validatePhoneIfPresent(phone, true) && valid;
        removeFieldError(pin);
        sanitizeDigitsOnly(pin);
        if (!pin.value || pin.value.length !== 4) {
          setFieldError(pin, "PIN must be 4 digits");
          valid = false;
        }
        return valid;
      }

      function validateProfileForm() {
        let valid = true;
        valid = validateRequired(document.getElementById('fpc-name'), "FPC name is required") && valid;
        valid = validatePhoneIfPresent(document.getElementById('fpc-phone'), true) && valid;
        valid = validateRequired(document.getElementById('fpc-relation'), "Relationship is required") && valid;
        valid = validateRequired(document.getElementById('fpc-priority'), "Priority is required") && valid;
        return valid;
      }

      function validateLogForm() {
        let valid = true;
        valid = validateRequired(document.getElementById('log-package'), "Package is required") && valid;
        valid = validateRequired(document.getElementById('place-type'), "Place type is required") && valid;
        valid = validateRequired(document.getElementById('address'), "Address/Location/Landmark is required") && valid;
        valid = validateRequired(document.getElementById('state-select'), "State is required") && valid;
        valid = validateRequired(document.getElementById('lga-select'), "LGA is required") && valid;
        document.querySelectorAll('.phone-entry').forEach((input) => {
          valid = validatePhoneIfPresent(input, false) && valid;
        });
        return valid;
      }

      function titleCaseSlug(value) {
        return String(value || '')
          .replace(/[-_]+/g, ' ')
          .replace(/\s+/g, ' ')
          .trim()
          .split(' ')
          .filter(Boolean)
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
          .join(' ');
      }

      function normalizeNigeriaPayload(payload) {
        const normalized = {};
        if (Array.isArray(payload)) {
          payload.forEach((entry) => {
            const state = entry.state || entry.name || entry.State || entry.Name;
            const lgas = entry.lgas || entry.lga || entry.LGAs || entry.locals || [];
            const prettyState = titleCaseSlug(state);
            if (prettyState) {
              normalized[prettyState] = Array.isArray(lgas) ? lgas.map(titleCaseSlug) : [];
            }
          });
        } else if (payload && typeof payload === 'object') {
          Object.keys(payload).forEach((key) => {
            const prettyState = titleCaseSlug(key);
            normalized[prettyState] = Array.isArray(payload[key]) ? payload[key].map(titleCaseSlug) : [];
          });
        }
        return normalized;
      }

      function mergeNigeriaDataWithStateList(data) {
        const out = {};
        ALL_STATES.forEach((state) => {
          out[state] = Array.isArray(data[state]) ? [...new Set(data[state])].sort() : [];
        });
        Object.keys(data).forEach((state) => {
          if (!out[state]) out[state] = Array.isArray(data[state]) ? [...new Set(data[state])].sort() : [];
        });
        return out;
      }

      function populateStateOptions() {
        stateSel.innerHTML = '<option value="">State *</option>';
        Object.keys(nigeriaData).sort().forEach((s) => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.innerText = s;
          stateSel.appendChild(opt);
        });
      }

      async function loadNigeriaData() {
        const sources = [
          "https://raw.githubusercontent.com/afeibukun/nigerian-state-lgas-wards-polling-units/refs/heads/main/states-and-lgas.json",
          "https://raw.githubusercontent.com/kennymartins/nigerian-states-LGAs/master/states-and-lgas.json",
          "https://raw.githubusercontent.com/Temmiecode/nigeria-address-data/main/src/nigeriaAddressData.json"
        ];
        for (const url of sources) {
          try {
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) continue;
            const payload = await res.json();
            const normalized = normalizeNigeriaPayload(payload);
            if (Object.keys(normalized).length > 0) {
              nigeriaData = mergeNigeriaDataWithStateList(normalized);
              populateStateOptions();
              return;
            }
          } catch (_) {
            // try next source
          }
        }
        nigeriaData = mergeNigeriaDataWithStateList(nigeriaData);
        populateStateOptions();
      }

      function updateLandingHero(nextIndex) {
        const image = document.getElementById('landing-hero-image');
        const badge = document.getElementById('landing-hero-badge');
        const headline = document.getElementById('landing-hero-headline');
        const subtext = document.getElementById('landing-hero-subtext');
        if (!image || !badge || !headline || !subtext) return;
        landingHeroIndex = nextIndex % LANDING_HERO_IMAGES.length;
        image.classList.add('is-changing');
        setTimeout(() => {
          image.src = LANDING_HERO_IMAGES[landingHeroIndex];
          badge.innerText = LANDING_HERO_BADGES[landingHeroIndex] || LANDING_HERO_BADGES[0];
          headline.innerText = LANDING_HERO_HEADLINES[0];
          image.classList.remove('is-changing');
        }, 220);
      }

      function startLandingHeroRotation() {
        if (landingHeroInterval) clearInterval(landingHeroInterval);
        updateLandingHero(landingHeroIndex);
        landingHeroInterval = setInterval(() => {
          updateLandingHero((landingHeroIndex + 1) % LANDING_HERO_IMAGES.length);
        }, 5200);
      }

      function updateTestimonial(nextIndex) {
        const quote = document.getElementById('testimonial-quote');
        const name = document.getElementById('testimonial-name');
        const role = document.getElementById('testimonial-role');
        const avatar = document.getElementById('testimonial-avatar');
        const card = document.getElementById('testimonial-card');
        if (!quote || !name || !role || !avatar || !card || !TESTIMONIALS.length) return;

        testimonialIndex = nextIndex % TESTIMONIALS.length;
        const item = TESTIMONIALS[testimonialIndex];

        card.classList.remove('border-blue-500', 'border-cyan-400', 'border-indigo-400');
        card.classList.add(item.borderClass || 'border-blue-500');
        role.classList.remove('text-blue-400', 'text-cyan-500', 'text-indigo-500');
        role.classList.add(item.accentClass || 'text-blue-400');

        quote.innerText = item.quote || '';
        name.innerText = item.name || '';
        role.innerText = item.role || '';
        avatar.src = item.avatar || '';

        for (let i = 0; i < TESTIMONIALS.length; i++) {
          const dot = document.getElementById(`testimonial-dot-${i}`);
          if (!dot) continue;
          dot.classList.toggle('bg-blue-500', i === testimonialIndex);
          dot.classList.toggle('bg-blue-200', i !== testimonialIndex);
        }
      }

      function startTestimonialsRotation() {
        if (testimonialInterval) clearInterval(testimonialInterval);
        updateTestimonial(testimonialIndex);
        testimonialInterval = setInterval(() => {
          updateTestimonial((testimonialIndex + 1) % TESTIMONIALS.length);
        }, 5000);
      }

      function ensureMapInitialized() {
        if (mapRoot || !window.am5 || !window.am5map || !window.am5geodata_nigeriaLow) return;
        mapRoot = am5.Root.new("nigeria-map-chart");
        mapRoot._logo?.dispose();

        const chart = mapRoot.container.children.push(
          am5map.MapChart.new(mapRoot, {
            panX: "none",
            panY: "none",
            wheelX: "none",
            wheelY: "none",
            projection: am5map.geoMercator()
          })
        );

        polygonSeries = chart.series.push(
          am5map.MapPolygonSeries.new(mapRoot, {
            geoJSON: am5geodata_nigeriaLow,
            valueField: "value",
            calculateAggregates: true
          })
        );

        polygonSeries.mapPolygons.template.setAll({
          stroke: am5.color(0x60a5fa),
          strokeWidth: 1,
          interactive: true,
          tooltipHTML: "{tooltipHTML}"
        });
        polygonSeries.mapPolygons.template.adapters.add("fill", (fill, target) => {
          const v = target.dataItem?.dataContext?.value || 0;
          if (v >= 500) return am5.color(0x93c5fd);
          if (v >= 200) return am5.color(0xbfdbfe);
          return am5.color(0xdbeafe);
        });

        dotSeries = chart.series.push(
          am5map.MapPointSeries.new(mapRoot, {
            latitudeField: "lat",
            longitudeField: "lng"
          })
        );
        dotSeries.bullets.push((root, dataItem) => {
          const yellow = dataItem.dataContext?.status === "yellow";
          const pulseDuration = 700 + Math.floor(Math.random() * 1200);
          const pulseStartScale = 0.78 + Math.random() * 0.28;
          const pulseEndScale = yellow ? (1.2 + Math.random() * 0.35) : (1.08 + Math.random() * 0.24);
          const pulseStartOpacity = yellow ? (0.45 + Math.random() * 0.25) : (0.18 + Math.random() * 0.2);
          const pulseEndOpacity = yellow ? 1 : (0.58 + Math.random() * 0.28);
          const circle = am5.Circle.new(root, {
            radius: yellow ? 1.35 : 0.72,
            fill: yellow ? am5.color(0xf59e0b) : am5.color(0x22c55e),
            fillOpacity: yellow ? 0.8 : 0.45,
            strokeOpacity: 0
          });
          circle.animate({ key: "scale", from: pulseStartScale, to: pulseEndScale, duration: pulseDuration, loops: Infinity });
          circle.animate({ key: "fillOpacity", from: pulseStartOpacity, to: pulseEndOpacity, duration: pulseDuration, loops: Infinity });
          return am5.Bullet.new(root, { sprite: circle });
        });
      }

      function pointInRing(lon, lat, ring) {
        let inside = false;
        for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
          const xi = ring[i][0], yi = ring[i][1];
          const xj = ring[j][0], yj = ring[j][1];
          const intersects = ((yi > lat) !== (yj > lat)) &&
            (lon < ((xj - xi) * (lat - yi)) / ((yj - yi) || 0.0000001) + xi);
          if (intersects) inside = !inside;
        }
        return inside;
      }

      function pointInPolygonWithHoles(lon, lat, polygonCoords) {
        if (!polygonCoords?.length) return false;
        if (!pointInRing(lon, lat, polygonCoords[0])) return false;
        for (let i = 1; i < polygonCoords.length; i += 1) {
          if (pointInRing(lon, lat, polygonCoords[i])) return false;
        }
        return true;
      }

      function polygonBBox(outerRing) {
        let minLon = Infinity, maxLon = -Infinity, minLat = Infinity, maxLat = -Infinity;
        outerRing.forEach((pt) => {
          const lon = pt[0];
          const lat = pt[1];
          if (lon < minLon) minLon = lon;
          if (lon > maxLon) maxLon = lon;
          if (lat < minLat) minLat = lat;
          if (lat > maxLat) maxLat = lat;
        });
        return { minLon, maxLon, minLat, maxLat };
      }

      function canonicalStateName(value) {
        return String(value || "")
          .toLowerCase()
          .replace(/\bstate\b/g, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function buildStateGeometryPool() {
        if (stateGeometryPool.length || !window.am5geodata_nigeriaLow?.features) return;
        const pool = [];
        am5geodata_nigeriaLow.features.forEach((feature) => {
          const name = feature?.properties?.name || feature?.id || "Unknown";
          const geometry = feature?.geometry;
          if (!geometry) return;
          if (geometry.type === "Polygon") {
            const coords = geometry.coordinates;
            if (coords?.[0]?.length) {
              pool.push({ name, id: feature.id, coords, bbox: polygonBBox(coords[0]) });
            }
          } else if (geometry.type === "MultiPolygon") {
            geometry.coordinates.forEach((polyCoords) => {
              if (polyCoords?.[0]?.length) {
                pool.push({ name, id: feature.id, coords: polyCoords, bbox: polygonBBox(polyCoords[0]) });
              }
            });
          }
        });
        stateGeometryPool = pool;
      }

      function randomPointInsideState(stateShape, maxAttempts = 80) {
        for (let i = 0; i < maxAttempts; i += 1) {
          const lon = stateShape.bbox.minLon + Math.random() * (stateShape.bbox.maxLon - stateShape.bbox.minLon);
          const lat = stateShape.bbox.minLat + Math.random() * (stateShape.bbox.maxLat - stateShape.bbox.minLat);
          if (pointInPolygonWithHoles(lon, lat, stateShape.coords)) {
            return { lng: lon, lat };
          }
        }
        return null;
      }

      function buildSimulatedUsers(total) {
        const randomTotal = Math.floor(1800 + Math.random() * 3400);
        const target = Number.isFinite(total) && total > 0 ? total : randomTotal;
        simulatedYellowRatio = 0.08 + Math.random() * 0.2;
        buildStateGeometryPool();
        const users = [];
        let guard = 0;
        while (users.length < target && guard < target * 50) {
          guard += 1;
          if (!stateGeometryPool.length) break;
          const stateShape = stateGeometryPool[Math.floor(Math.random() * stateGeometryPool.length)];
          const point = randomPointInsideState(stateShape);
          if (!point) continue;
          const isYellow = Math.random() < simulatedYellowRatio;
          users.push({
            lat: point.lat,
            lng: point.lng,
            state: stateShape.name,
            remainingMins: isYellow
              ? Math.floor(Math.random() * 120)
              : (121 + Math.floor(Math.random() * ((48 * 60) - 121)))
          });
        }
        simulatedUsers = users;
      }

      function computeStateTopCombos() {
        const out = {};
        simulatedUsers.forEach((u) => {
          const key = canonicalStateName(u.state);
          if (!out[key]) out[key] = { total: 0, logged: 0, almost: 0 };
          out[key].total += 1;
          if (u.remainingMins <= 120) out[key].almost += 1;
          else out[key].logged += 1;
        });
        return out;
      }

      function renderMap() {
        if (!polygonSeries || !dotSeries) return;
        const stateStats = computeStateTopCombos();
        const mapData = [];
        const features = window.am5geodata_nigeriaLow?.features || [];
        const seen = new Set();
        features.forEach((feature) => {
          const geoId = feature?.id;
          const stateName = feature?.properties?.name || geoId || "Unknown";
          if (!geoId || seen.has(geoId)) return;
          seen.add(geoId);
          const info = stateStats[canonicalStateName(stateName)];
          if (!info) {
            mapData.push({
              id: geoId,
              name: stateName,
              value: 0,
              tooltipHTML: `<strong>${stateName}</strong><br>No active users`
            });
            return;
          }
          mapData.push({
            id: geoId,
            name: stateName,
            value: info.total,
            tooltipHTML: `<strong>${stateName}</strong><br>Total: ${info.total}<br>Green: ${info.logged}<br>Yellow: ${info.almost}`
          });
        });
        polygonSeries.data.setAll(mapData);

        const dots = simulatedUsers.map((u) => ({
          lat: u.lat,
          lng: u.lng,
          status: u.remainingMins <= 120 ? "yellow" : "green"
        })).sort((a, b) => (a.status === "yellow" ? 1 : 0) - (b.status === "yellow" ? 1 : 0));
        dotSeries.data.setAll(dots);

        const almostCount = dots.filter((d) => d.status === "yellow").length;
        const loggedCount = dots.length - almostCount;
        document.getElementById('active-users-count').innerText = `${dots.length.toLocaleString()} Users`;
        document.getElementById('logged-users-count').innerText = loggedCount.toLocaleString();
        document.getElementById('almost-users-count').innerText = almostCount.toLocaleString();
      }

      function startUsersMapPulse() {
        ensureMapInitialized();
        if (!simulatedUsers.length) buildSimulatedUsers();
        renderMap();
        if (usersPulseInt) clearInterval(usersPulseInt);
        usersPulseInt = setInterval(() => {
          simulatedUsers.forEach((u) => {
            if (u.remainingMins > 0) u.remainingMins -= 1;
          });
          renderMap();
        }, 15000);
      }

      function startSocialProof() {
        stopSocialProof(); // ensure single instance
        toastInterval = setInterval(() => {
          const toast = document.getElementById('social-proof-toast');
          const txt = document.getElementById('toast-text');
          txt.innerText = socialProofEvents[Math.floor(Math.random() * socialProofEvents.length)];
          toast.classList.add('show');
          clearTimeout(toastVisibleTimeout);
          toastVisibleTimeout = setTimeout(() => toast.classList.remove('show'), 3200);
        }, 12000);
      }

      function stopSocialProof() {
        const toast = document.getElementById('social-proof-toast');
        toast.classList.remove('show');
        if (toastInterval) clearInterval(toastInterval);
        toastInterval = null;
        if (toastVisibleTimeout) clearTimeout(toastVisibleTimeout);
        toastVisibleTimeout = null;
      }

      function screenWantsSocialProof(id) {
        return (id === 'screen-landing' || id === 'screen-home');
      }

      function showScreen(id) {
        document.querySelectorAll('.app-screen').forEach(s => s.style.display = 'none');
        const target = document.getElementById(id);
        if (target) {
          target.style.display = 'flex';
          target.scrollTop = 0;
        }

        // nav active states
        document.querySelectorAll('.nav-btn-el').forEach(item => item.classList.remove('active'));
        const navHome = document.querySelector('[data-screen="screen-home"]');
        const navProfile = document.querySelector('[data-screen="screen-profile"]');
        const navLog = document.getElementById('nav-log');

        if (id === 'screen-home') navHome?.classList.add('active');
        if (id === 'screen-profile') navProfile?.classList.add('active');
        if (id === 'screen-log-form' || id === 'screen-active') navLog?.classList.add('active');

        // social proof should not annoy / overlap key screens
        if (screenWantsSocialProof(id)) startSocialProof();
        else stopSocialProof();
      }

      function toggleAuthMode() {
        const isSignup = document.getElementById('auth-title').innerText === 'Sign Up';
        setAuthModeUi(!isSignup);
      }

      function openAuth(mode) {
        const goSignup = mode === 'signup';
        stopPaymentPolling();
        closePaymentModal();
        setAuthModeUi(goSignup);
        showScreen('screen-auth');
      }

      function needsUpgrade(requiredPkg) {
        return !packageCovers(signedInUser.package || unlockedPackage || "Basic", requiredPkg);
      }

      function ensureSelectedPackageAtLeast(requiredPkg) {
        const pkgEl = document.getElementById('log-package');
        if (!pkgEl) return;
        const current = pkgEl.value || "Basic";
        if (!packageCovers(current, requiredPkg)) {
          setSelectedPackage(requiredPkg);
        }
      }

      function triggerUpgrade(requiredPkg, feature) {
        pendingUpgradeTarget = requiredPkg;
        document.getElementById('upgrade-desc').innerHTML =
          `The <span class="font-black text-blue-600">${requiredPkg}</span> Package is required for <span class="font-black">${feature}</span>.`;
        document.getElementById('modal-upgrade').classList.remove('hidden');
      }

      function closeUpgradeModal() {
        document.getElementById('modal-upgrade').classList.add('hidden');
      }

      function handleLogNav() {
        if (currentActive) showScreen('screen-active');
        else showScreen('screen-log-form');
      }

      function addPhoneField() {
        const container = document.getElementById('phone-container');
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2 mt-2';
        div.innerHTML = `
          <input type="tel" maxlength="11" placeholder="Secondary Phone" inputmode="numeric"
                 class="form-input phone-entry" pattern="[0-9]{11}" minlength="11" oninput="this.value=this.value.replace(/\\D/g,'')">
          <button type="button" class="text-rose-500 px-2" aria-label="Remove phone">
            <i class="ph-bold ph-minus-circle text-xl"></i>
          </button>`;
        div.querySelector('button').onclick = () => div.remove();
        container.appendChild(div);
      }

      // Location dropdowns
      stateSel.onchange = (e) => {
        lgaSel.innerHTML = '<option value="">LGA *</option>';
        lgaSel.disabled = !e.target.value;
        if (e.target.value) {
          const lgas = Array.isArray(nigeriaData[e.target.value]) ? nigeriaData[e.target.value] : [];
          lgas.sort().forEach(l => {
            const opt = document.createElement('option');
            opt.value = l; opt.innerText = l;
            lgaSel.appendChild(opt);
          });
          if (!lgas.length) {
            const opt = document.createElement('option');
            opt.value = "lga_unavailable";
            opt.innerText = "No LGA list loaded for this state";
            lgaSel.appendChild(opt);
          }
        }
      };

      async function getCurrentGPS() {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000 });
        });
      }

      async function activateGPS() {
        ensureSelectedPackageAtLeast("Standard");
        if (needsUpgrade("Standard")) {
          triggerUpgrade("Standard", "Live GPS Tracking");
          return;
        }
        const status = document.getElementById('gps-status');
        status.classList.remove('hidden');
        status.innerText = "Fetching GPS...";
        try {
          const pos = await getCurrentGPS();
          const { latitude, longitude } = pos.coords;
          status.innerText = `GPS Saved: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
          status.classList.remove('text-rose-600');
          status.classList.add('text-emerald-600');
          status.dataset.lat = latitude;
          status.dataset.lng = longitude;
        } catch (e) {
          status.innerText = "GPS Failed (permission / timeout)";
          status.classList.remove('text-emerald-600');
          status.classList.add('text-rose-600');
        }
      }

      async function logGPSPoint(reason) {
        if (!currentActive) return;
        try {
          const pos = await getCurrentGPS();
          const { latitude, longitude } = pos.coords;
          currentActive.gpsLogs.push({
            reason,
            timestamp: new Date().toISOString(),
            latitude,
            longitude
          });
          const status = document.getElementById('gps-status');
          status.classList.remove('hidden');
          status.classList.remove('text-rose-600');
          status.classList.add('text-emerald-600');
          status.innerText = `GPS Logged: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
          if (currentActive.meetupId) {
            try {
              await sendToBackend({
                action: "update",
                sheet: "Meetups",
                filters: { id: currentActive.meetupId },
                data: {
                  last_gps: `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`,
                  last_gps_at: new Date().toISOString(),
                  status: "ACTIVE_WATCH"
                }
              });
            } catch (err) {
              console.error("Meetup GPS update failed:", err);
            }
          }
          renderMeetupDetails();
        } catch (err) {
          currentActive.gpsLogs.push({
            reason,
            timestamp: new Date().toISOString(),
            error: "GPS unavailable"
          });
          if (currentActive.meetupId) {
            try {
              await sendToBackend({
                action: "update",
                sheet: "Meetups",
                filters: { id: currentActive.meetupId },
                data: {
                  gps_error: "GPS unavailable",
                  gps_error_at: new Date().toISOString()
                }
              });
            } catch (updateErr) {
              console.error("Meetup GPS error update failed:", updateErr);
            }
          }
          renderMeetupDetails();
        }
      }

      function startGPSLogging() {
        clearInterval(gpsLogInterval);
        logGPSPoint("start");
        gpsLogInterval = setInterval(() => {
          logGPSPoint("every_10_minutes");
        }, GPS_LOG_INTERVAL_MS);
      }

      function stopGPSLogging() {
        clearInterval(gpsLogInterval);
        gpsLogInterval = null;
      }

      async function collectMeetupDataFromForm() {
        const dynamicFields = extractDynamicFormData(document.getElementById('log-form'));
        const strangerFiles = inStranger.files ? Array.from(inStranger.files) : [];
        const supportFiles = inSupport.files ? Array.from(inSupport.files) : [];
        const strangerImageDataUrls = await filesToDataUrls(strangerFiles.slice(0, 1));
        const supportImageDataUrls = await filesToDataUrls(supportFiles);
        return {
          selectedPackage: document.getElementById('log-package').value || "Basic",
          fullName: `${document.getElementById('fname').value} ${document.getElementById('lname').value}`.trim(),
          phones: [...document.querySelectorAll('.phone-entry')].map((el) => el.value).filter(Boolean),
          nickname: document.getElementById('nickname').value.trim(),
          friends: document.getElementById('friends').value.trim(),
          placeType: document.getElementById('place-type').value,
          address: document.getElementById('address').value.trim(),
          state: document.getElementById('state-select').value,
          lga: document.getElementById('lga-select').value,
          extra: document.getElementById('info-extra').value.trim(),
          strangerImageDataUrls,
          supportImageDataUrls,
          dynamicFields
        };
      }

      function renderActiveMeetupHomeCard() {
        if (!currentActive?.details) return;
        document.getElementById('active-meetup-name-display').innerText = currentActive.details.fullName || "Logging Active";
      }

      function renderMeetupDetails() {
        const detailsEl = document.getElementById('active-meetup-details');
        const updatesEl = document.getElementById('meetup-updates-list');
        if (!currentActive?.details) {
          detailsEl.innerText = "No active meetup.";
          updatesEl.innerHTML = "";
          return;
        }
        const d = currentActive.details;
        detailsEl.innerHTML = `
          <p><span class="font-black text-blue-900">Name:</span> ${d.fullName || '-'}</p>
          <p><span class="font-black text-blue-900">Phones:</span> ${Array.isArray(d.phones) ? (d.phones.join(', ') || '-') : '-'}</p>
          <p><span class="font-black text-blue-900">Place:</span> ${d.placeType || '-'}</p>
          <p><span class="font-black text-blue-900">Location:</span> ${d.address || '-'}</p>
          <p><span class="font-black text-blue-900">State/LGA:</span> ${d.state || '-'} / ${d.lga || '-'}</p>
        `;
        const images = [...(d.strangerImageDataUrls || []), ...(d.supportImageDataUrls || [])];
        if (images.length) {
          detailsEl.innerHTML += `
            <div class="pt-2">
              <p><span class="font-black text-blue-900">Images:</span></p>
              <div class="mt-2 flex flex-wrap gap-2">
                ${images.map((src) => `<img src="${src}" class="w-14 h-14 rounded-lg object-cover border border-blue-100">`).join('')}
              </div>
            </div>`;
        }
        if (Array.isArray(currentActive.gpsLogs) && currentActive.gpsLogs.length) {
          const lastGPS = [...currentActive.gpsLogs].reverse().find((g) => g.latitude && g.longitude);
          detailsEl.innerHTML += `
            <div class="pt-2 space-y-1">
              <p><span class="font-black text-blue-900">Latest GPS:</span> ${lastGPS ? `${lastGPS.latitude.toFixed(5)}, ${lastGPS.longitude.toFixed(5)}` : 'Unavailable'}</p>
              <p><span class="font-black text-blue-900">GPS Logs:</span></p>
              <div class="max-h-28 overflow-y-auto bg-blue-50 border border-blue-100 rounded-lg p-2 text-[10px]">
                ${currentActive.gpsLogs.slice().reverse().map((g) => `<p>${new Date(g.timestamp).toLocaleTimeString()} • ${g.latitude ? `${g.latitude.toFixed(5)}, ${g.longitude.toFixed(5)}` : g.error}</p>`).join('')}
              </div>
            </div>`;
        }
        updatesEl.innerHTML = (currentActive.updates || []).slice().reverse().map((u) => {
          return `<div class="bg-blue-50 border border-blue-100 rounded-xl p-2"><p>${u.note}</p><p class="text-[10px] text-blue-500 mt-1">${u.time}</p></div>`;
        }).join('');
      }

      function updateProfileUserDetails() {
        document.getElementById('profile-user-name').innerText = `Name: ${signedInUser.name || "-"}`;
        document.getElementById('profile-user-phone').innerText = `Phone: ${signedInUser.phone || "-"}`;
        document.getElementById('header-user-name').innerText = signedInUser.name ? signedInUser.name : "";
      }

      function distance(a, b) {
        return Math.hypot((a.x || 0) - (b.x || 0), (a.y || 0) - (b.y || 0));
      }

      function averagePoint(points) {
        const sum = points.reduce((acc, p) => ({ x: acc.x + p.x, y: acc.y + p.y }), { x: 0, y: 0 });
        return { x: sum.x / points.length, y: sum.y / points.length };
      }

      async function ensureFaceModelsLoaded(statusEl) {
        if (faceModelsLoaded) return;
        if (!window.faceapi) throw new Error("Face API not available");
        const modelSources = [
          "https://justadudewhohacks.github.io/face-api.js/models"
        ];
        let loaded = false;
        for (const modelUri of modelSources) {
          try {
            statusEl.innerText = "Loading liveness models...";
            await faceapi.nets.tinyFaceDetector.loadFromUri(modelUri);
            await faceapi.nets.faceLandmark68TinyNet.loadFromUri(modelUri);
            await faceapi.nets.faceExpressionNet.loadFromUri(modelUri);
            loaded = true;
            break;
          } catch (_) {
            // try next source
          }
        }
        if (!loaded) throw new Error("ModelLoadError");
        faceModelsLoaded = true;
      }

      function getCurrentLivenessStepText() {
        if (!livenessSession) return "Expression step pending";
        if (!livenessSession.smileDone) return `Step 1/3: ${LIVENESS_STEPS[0]}`;
        if (!livenessSession.leftDone) return `Step 2/3: ${LIVENESS_STEPS[1]}`;
        if (!livenessSession.rightDone) return `Step 3/3: ${LIVENESS_STEPS[2]}`;
        return "All expression checks detected";
      }

      function allLivenessChecksPassed() {
        return !!(livenessSession?.smileDone && livenessSession?.leftDone && livenessSession?.rightDone);
      }

      async function processLivenessFrame() {
        if (!livenessSession || livenessSession.processing) return;
        const video = document.getElementById('webcam');
        const status = document.getElementById('verify-status');
        const stepEl = document.getElementById('verify-step');
        if (!video.srcObject) return;
        livenessSession.processing = true;
        try {
          const detection = await faceapi
            .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
            .withFaceLandmarks(true)
            .withFaceExpressions();

          if (!detection) {
            status.innerText = "No face detected. Center your face.";
            status.style.color = "#ef4444";
            stepEl.innerText = getCurrentLivenessStepText();
            return;
          }

          status.innerText = "Face detected. Keep steady.";
          status.style.color = "";
          const landmarks = detection.landmarks;
          const expressions = detection.expressions || {};

          if (!livenessSession.smileDone && (expressions.happy || 0) >= 0.65) {
            livenessSession.smileDone = true;
          }

          const nosePoints = landmarks.getNose();
          const noseTip = nosePoints[3] || nosePoints[Math.floor(nosePoints.length / 2)];
          const leftEye = landmarks.getLeftEye();
          const rightEye = landmarks.getRightEye();
          const leftEyeMid = averagePoint(leftEye);
          const rightEyeMid = averagePoint(rightEye);
          const eyeMid = { x: (leftEyeMid.x + rightEyeMid.x) / 2, y: (leftEyeMid.y + rightEyeMid.y) / 2 };
          const eyeDistance = distance(leftEyeMid, rightEyeMid) || 1;
          const yaw = (noseTip.x - eyeMid.x) / eyeDistance;
          if (yaw < -0.09) livenessSession.leftDone = true;
          if (yaw > 0.09) livenessSession.rightDone = true;

          livenessStepIndex =
            (livenessSession.smileDone ? 1 : 0) +
            (livenessSession.leftDone ? 1 : 0) +
            (livenessSession.rightDone ? 1 : 0);

          stepEl.innerText = getCurrentLivenessStepText();
          if (allLivenessChecksPassed()) {
            stepEl.style.color = "#10b981";
            status.innerText = "Liveness checks passed. Capture now.";
            document.getElementById('btn-verify-capture').classList.remove('hidden');
            if (livenessAutoTimer) {
              clearInterval(livenessAutoTimer);
              livenessAutoTimer = null;
            }
          } else {
            document.getElementById('btn-verify-capture').classList.add('hidden');
          }
        } catch (_) {
          status.innerText = "Liveness detection failed. Hold still and retry.";
          status.style.color = "#ef4444";
        } finally {
          if (livenessSession) livenessSession.processing = false;
        }
      }

      // Images (Confidence Plus feature)
      function gateFilePick(requiredPkg, inputEl, labelEl, filenameEl, isMulti) {
        ensureSelectedPackageAtLeast(requiredPkg);
        if (needsUpgrade(requiredPkg)) {
          triggerUpgrade(requiredPkg, "Pictures / Visual Evidence");
          return;
        }
        inputEl.click();
      }

      function requiredPackageFromFeatures() {
        const gpsStatus = document.getElementById('gps-status');
        const hasGps = !!(gpsStatus?.dataset?.lat && gpsStatus?.dataset?.lng);
        const hasImages = (inStranger?.files?.length || 0) > 0 || (inSupport?.files?.length || 0) > 0;
        if (hasImages) return "Confidence Plus";
        if (hasGps) return "Standard";
        return "Basic";
      }

      async function getCameraPermission() {
        if (!navigator.permissions?.query) return cameraPermissionState;
        try {
          const result = await navigator.permissions.query({ name: 'camera' });
          cameraPermissionState = result.state;
          result.onchange = () => { cameraPermissionState = result.state; };
          return cameraPermissionState;
        } catch (_) {
          return cameraPermissionState;
        }
      }

      function describeCameraError(err) {
        if (!err) return "Camera access failed.";
        if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") return "Camera permission denied. Please allow camera access in browser settings.";
        if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") return "No camera device found on this device.";
        if (err.name === "NotReadableError" || err.name === "TrackStartError") return "Camera is busy in another app/tab. Close other camera apps and try again.";
        if (err.name === "SecurityError") return "Camera requires HTTPS or localhost.";
        if (err.name === "AbortError") return "Camera request was interrupted. Please retry.";
        return "Unable to access camera right now. Please retry.";
      }

      async function openCamera(videoEl) {
        closeCamera(videoEl);
        if (!window.isSecureContext) throw new Error("SecurityError");
        if (!navigator.mediaDevices?.getUserMedia) throw new Error("NotSupportedError");

        const permission = await getCameraPermission();
        if (permission === "denied") throw new Error("NotAllowedError");

        const devices = await navigator.mediaDevices.enumerateDevices();
        if (!devices.some((d) => d.kind === "videoinput")) throw new Error("NotFoundError");

        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } },
          audio: false
        });
        videoEl.srcObject = stream;
        await videoEl.play().catch(() => {});
      }

      function closeCamera(videoEl) {
        if (videoEl.srcObject) videoEl.srcObject.getTracks().forEach((t) => t.stop());
        videoEl.srcObject = null;
      }

      function captureFrame(videoEl, canvasEl) {
        const ctx = canvasEl.getContext('2d');
        canvasEl.width = videoEl.videoWidth || 320;
        canvasEl.height = videoEl.videoHeight || 240;
        ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
        return canvasEl.toDataURL('image/jpeg', 0.8);
      }

      function closePreLogModal() {
        document.getElementById('modal-prelog-photo').classList.add('hidden');
        closeCamera(document.getElementById('prelog-webcam'));
      }

      async function openPreLogModal() {
        const modal = document.getElementById('modal-prelog-photo');
        const status = document.getElementById('prelog-status');
        const video = document.getElementById('prelog-webcam');
        modal.classList.remove('hidden');
        status.style.color = "";
        status.innerText = "Opening camera...";
        try {
          await openCamera(video);
          status.innerText = "Camera ready";
        } catch (err) {
          status.innerText = describeCameraError(err);
          status.style.color = "#ef4444";
        }
      }

      async function scoreImageSimilarity(imgA, imgB) {
        const load = (src) => new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = src;
        });
        const [a, b] = await Promise.all([load(imgA), load(imgB)]);
        const size = 48;
        const c1 = document.createElement('canvas');
        const c2 = document.createElement('canvas');
        c1.width = c1.height = c2.width = c2.height = size;
        const x1 = c1.getContext('2d');
        const x2 = c2.getContext('2d');
        x1.drawImage(a, 0, 0, size, size);
        x2.drawImage(b, 0, 0, size, size);
        const d1 = x1.getImageData(0, 0, size, size).data;
        const d2 = x2.getImageData(0, 0, size, size).data;
        let diff = 0;
        for (let i = 0; i < d1.length; i += 4) {
          const g1 = (d1[i] + d1[i + 1] + d1[i + 2]) / 3;
          const g2 = (d2[i] + d2[i + 1] + d2[i + 2]) / 3;
          diff += Math.abs(g1 - g2);
        }
        const max = (d1.length / 4) * 255;
        return 1 - (diff / max);
      }

      async function beginMeetupAfterCapture() {
        const activePackage = pendingMeetupData?.selectedPackage || unlockedPackage || "Basic";
        let meetupId = "";
        try {
          const createResp = await sendToBackend({
            action: "create",
            sheet: "Meetups",
            data: {
              user_phone: signedInUser.phone || "",
              user_name: signedInUser.name || "",
              selected_package: activePackage,
              full_name: pendingMeetupData?.fullName || "",
              phones_json: JSON.stringify(pendingMeetupData?.phones || []),
              stranger_images_json: JSON.stringify(pendingMeetupData?.strangerImageDataUrls || []),
              support_images_json: JSON.stringify(pendingMeetupData?.supportImageDataUrls || []),
              place_type: pendingMeetupData?.placeType || "",
              address: pendingMeetupData?.address || "",
              state: pendingMeetupData?.state || "",
              lga: pendingMeetupData?.lga || "",
              prelog_photo: preLogImageDataUrl || "",
              status: "ACTIVE_WATCH",
              started_at: new Date().toISOString(),
              ...(pendingMeetupData?.dynamicFields || {})
            }
          });
          meetupId = safeGetCreatedId(createResp);
        } catch (err) {
          console.error("Meetup create failed:", err);
        }

        currentActive = {
          start: Date.now(),
          pkg: activePackage,
          meetupId: meetupId || `local_${Date.now()}`,
          preLogPhoto: preLogImageDataUrl,
          gpsLogs: [],
          details: pendingMeetupData || {},
          updates: []
        };
        pendingMeetupData = null;
        document.getElementById('active-meetup-card-home').classList.remove('hidden');
        document.getElementById('no-active-meetup').classList.add('hidden');
        document.getElementById('protection-text').innerText =
          `The "Meetily ${activePackage}" switch is active. We will notify the authorities if you don't verify by the deadline.`;
        renderActiveMeetupHomeCard();
        renderMeetupDetails();
        startTimer();
        startGPSLogging();
        showScreen('screen-home');
      }

      // Liveness
      async function startLivenessCheck() {
        const modal = document.getElementById('modal-verify');
        const status = document.getElementById('verify-status');
        const stepEl = document.getElementById('verify-step');
        const video = document.getElementById('webcam');
        if (!currentActive?.preLogPhoto) {
          const proceed = confirm("Pre-log photo is missing for this restored session. End meetup without liveness?");
          if (proceed) {
            await endMeetup();
          }
          return;
        }
        modal.classList.remove('hidden');
        status.style.color = "";
        stepEl.style.color = "";
        livenessStepIndex = 0;
        stepEl.innerText = `Step 1/${LIVENESS_STEPS.length}: ${LIVENESS_STEPS[0]}`;
        status.innerText = "Opening camera...";
        document.getElementById('btn-verify-capture').classList.add('hidden');
        if (livenessAutoTimer) clearInterval(livenessAutoTimer);
        livenessAutoTimer = null;
        livenessSession = {
          smileDone: false,
          leftDone: false,
          rightDone: false,
          processing: false
        };

        try {
          await openCamera(video);
          await ensureFaceModelsLoaded(status);
          status.innerText = "Run liveness steps in front of camera...";
          livenessAutoTimer = setInterval(processLivenessFrame, 220);
        } catch (err) {
          const msg = err?.message === "ModelLoadError"
            ? "Liveness models could not load. Check internet and retry."
            : describeCameraError(err);
          alert(msg);
          closeVerifyModal();
        }
      }

      async function captureAndVerifyLiveness() {
        const status = document.getElementById('verify-status');
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('verify-canvas');
        if (!allLivenessChecksPassed()) {
          status.innerText = "Complete all expression steps first";
          status.style.color = "#ef4444";
          return;
        }
        if (!video.srcObject) {
          status.innerText = "Camera is not active";
          status.style.color = "#ef4444";
          return;
        }
        status.style.color = "";
        status.innerText = "Comparing images...";
        try {
          const liveImage = captureFrame(video, canvas);
          const score = await scoreImageSimilarity(currentActive.preLogPhoto, liveImage);
          if (score >= 0.60) {
            status.innerText = "Liveness confirmed";
            status.style.color = "#10b981";
            setTimeout(() => endMeetup(), 700);
          } else {
            status.innerText = "Face mismatch. Try again.";
            status.style.color = "#ef4444";
          }
        } catch (_) {
          status.innerText = "Verification failed. Try again.";
          status.style.color = "#ef4444";
        }
      }

      function closeVerifyModal() {
        document.getElementById('modal-verify').classList.add('hidden');
        if (livenessAutoTimer) {
          clearInterval(livenessAutoTimer);
          livenessAutoTimer = null;
        }
        livenessSession = null;
        closeCamera(document.getElementById('webcam'));
      }

      async function endMeetup() {
        if (currentActive?.meetupId) {
          try {
            await sendToBackend({
              action: "update",
              sheet: "Meetups",
              filters: { id: currentActive.meetupId },
              data: {
                status: "ENDED",
                ended_at: new Date().toISOString()
              }
            });
          } catch (err) {
            console.error("Meetup end update failed:", err);
          }
        }
        clearInterval(timerInt);
        timerInt = null;
        stopGPSLogging();
        currentActive = null;
        preLogImageDataUrl = "";
        closeVerifyModal();
        renderMeetupDetails();

        // UI reset
        document.getElementById('active-meetup-card-home').classList.add('hidden');
        document.getElementById('no-active-meetup').classList.remove('hidden');
        document.getElementById('active-meetup-name-display').innerText = "Logging Active";
        document.getElementById('meetup-update-input').value = "";

        showScreen('screen-home');
        alert("Meetily: Data permanently deleted. Meetup secured.");
      }

      function startTimer() {
        const baseStart = currentActive?.start || Date.now();
        const end = baseStart + SCREEN_DURATION;
        clearInterval(timerInt);
        timerInt = setInterval(() => {
          const diff = end - Date.now();
          if (diff <= 0) { clearInterval(timerInt); timerInt = null; return; }
          const h = Math.floor(diff / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          document.getElementById('timer').innerText =
            `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
          if (currentActive) currentActive.remainingMs = diff;
          const almostDone = diff <= (2 * 60 * 60 * 1000);
          const timerEl = document.getElementById('timer');
          timerEl.classList.toggle('text-amber-500', almostDone);
          timerEl.classList.toggle('text-blue-900', !almostDone);
        }, 1000);
      }

      // ======= Wire up events (this is where your “Log button not working” was) =======
      document.getElementById('btn-landing-signup').onclick = () => openAuth('signup');
      document.getElementById('btn-landing-signin').onclick = () => openAuth('signin');
      document.getElementById('btn-toggle-auth').onclick = toggleAuthMode;

      // Bottom nav
      document.querySelectorAll('[data-screen]').forEach(btn => {
        btn.onclick = () => showScreen(btn.dataset.screen);
      });
      document.getElementById('nav-log').onclick = handleLogNav;

      // Home card button
      document.getElementById('btn-home-log').onclick = () => showScreen('screen-log-form');

      document.querySelectorAll('#package-options .package-pill').forEach((btn) => {
        btn.onclick = () => setSelectedPackage(btn.dataset.package || "");
      });
      document.getElementById('log-package').onchange = syncPackageOptionCards;
      syncPackageOptionCards();
      armActionButtonLocks();

      // Active card click
      document.getElementById('active-meetup-card-home').onclick = () => {
        renderMeetupDetails();
        showScreen('screen-active');
      };

      // Add phone
      document.getElementById('btn-add-phone').onclick = addPhoneField;

      // GPS
      document.getElementById('btn-gps').onclick = activateGPS;

      // Images gating + filenames
      const inStranger = document.getElementById('img-stranger');
      const inSupport  = document.getElementById('img-support');
      document.getElementById('btn-img-stranger').onclick = () =>
        gateFilePick("Confidence Plus", inStranger, null, null, false);
      document.getElementById('btn-img-support').onclick = () =>
        gateFilePick("Confidence Plus", inSupport, null, null, true);

      inStranger.onchange = () => {
        document.getElementById('fn-img-stranger').innerText = inStranger.files?.[0]?.name ? `(${inStranger.files[0].name})` : "";
      };
      inSupport.onchange = () => {
        const count = inSupport.files ? inSupport.files.length : 0;
        document.getElementById('fn-img-support').innerText = count ? `(${count} file${count>1?'s':''} selected)` : "";
      };

      // Upgrade modal buttons
      document.getElementById('btn-upgrade-later').onclick = closeUpgradeModal;
      document.getElementById('btn-upgrade-paid').onclick = () => {
        // start real payment verification for required package
        closeUpgradeModal();
        openPaymentModal(signedInUser.virtualAccountNumber || "", pendingUpgradeTarget || "Basic");
        startPaymentPolling();
      };
      document.getElementById('btn-payment-close').onclick = () => {
        stopPaymentPolling();
        closePaymentModal();
      };
      document.getElementById('btn-payment-refresh').onclick = verifyPaymentNow;

      // Auth submit
      document.getElementById('auth-form').onsubmit = async (e) => {
        e.preventDefault();
        if (isAuthSubmitting) return;
        if (!validateAuthForm()) return;
        isAuthSubmitting = true;
        const submitBtn = document.getElementById('auth-submit-btn');
        const toggleBtn = document.getElementById('btn-toggle-auth');
        const nameInput = document.getElementById('auth-name').value.trim();
        const phoneInput = normalizePhone(document.getElementById('auth-phone').value);
        const pinInput = normalizePin(document.getElementById('auth-pin').value);
        const isSignup = document.getElementById('auth-title').innerText === 'Sign Up';
        setButtonLoading(submitBtn, true, isSignup ? "Creating account..." : "Signing in...");
        toggleBtn.disabled = true;
        toggleBtn.classList.add('opacity-60');

        try {
          if (isSignup) {
            const existingResp = await readUsersByPhone(phoneInput);
            const existingRows = extractRows(existingResp);
            if (findUserByPhone(existingRows, phoneInput)) {
              setFieldError(document.getElementById('auth-phone'), "User already exists. Please sign in.");
              alert("User already exists. Please sign in.");
              return;
            }

            const signupResp = await peygoSignup(nameInput || "User", phoneInput, pinInput);
            const signupUser = signupResp?.user || {};
            const paymentState = normalizePaymentStatus(signupResp, signupUser?.package || "Basic");
            const resolvedPhone = normalizeLocalPhone(signupUser?.phone || phoneInput || "");
            signedInUser = {
              name: signupUser?.name || nameInput || "User",
              phone: resolvedPhone,
              isPaid: paymentState.isPaid,
              package: paymentState.package || "Basic",
              virtualAccountNumber: signupUser?.virtualAccountNumber || paymentState.virtualAccountNumber || "",
              paidTotal: paymentState.paidTotal
            };
            unlockedPackage = signedInUser.package || "Basic";
            try {
              await createUserInDb({
                phone: resolvedPhone,
                phone_key: phoneKey(resolvedPhone),
                name: signedInUser.name,
                pin: pinInput,
                package: signedInUser.package,
                is_paid: signedInUser.isPaid,
                paid_total: signedInUser.paidTotal,
                virtual_account_number: signedInUser.virtualAccountNumber
              }, { skipExistsCheck: true });
            } catch (_) {
              setFieldError(document.getElementById('auth-phone'), "Unable to save new user.");
              return;
            }
          } else {
            const readResp = await readUsersByPhone(phoneInput);
            const users = extractRows(readResp);
            const foundUser = findUserByPhoneAndPin(users, phoneInput, pinInput);
            if (!foundUser) {
              setFieldError(document.getElementById('auth-pin'), "User not found or invalid PIN");
              alert("User not found or invalid PIN.");
              return;
            }

            const localPaid = extractNumber(foundUser.paid_total || foundUser.paidTotal) > 0 || String(foundUser.is_paid || "").toLowerCase() === "true";
            signedInUser = {
              name: String(foundUser.name || nameInput || "User"),
              phone: normalizeLocalPhone(foundUser.phone || phoneInput || ""),
              isPaid: localPaid,
              package: String(foundUser.package || "Basic"),
              virtualAccountNumber: foundUser.virtual_account_number || foundUser.virtualAccountNumber || "",
              paidTotal: extractNumber(foundUser.paid_total || foundUser.paidTotal)
            };
            unlockedPackage = signedInUser.package || "Basic";
            checkPaymentStatus(phoneInput, pinInput)
              .then((statusResp) => {
                const paymentState = normalizePaymentStatus(statusResp, signedInUser.package || "Basic");
                signedInUser.isPaid = paymentState.isPaid;
                signedInUser.package = paymentState.package;
                signedInUser.paidTotal = paymentState.paidTotal;
                signedInUser.virtualAccountNumber = paymentState.virtualAccountNumber || signedInUser.virtualAccountNumber;
                unlockedPackage = signedInUser.package;
                updateProfileUserDetails();
                updateUserInDb(signedInUser.phone, {
                  name: signedInUser.name,
                  phone_key: phoneKey(signedInUser.phone),
                  package: signedInUser.package,
                  is_paid: signedInUser.isPaid,
                  paid_total: signedInUser.paidTotal,
                  virtual_account_number: signedInUser.virtualAccountNumber
                }).catch(() => {});
              })
              .catch(() => {});
          }
        } catch (err) {
          setFieldError(document.getElementById('auth-phone'), err?.message || "Unable to reach server");
          return;
        } finally {
          setButtonLoading(submitBtn, false);
          toggleBtn.disabled = false;
          toggleBtn.classList.remove('opacity-60');
          isAuthSubmitting = false;
        }

        finalizeSigninUi();
        stopPaymentPolling();
        closePaymentModal();
      };

      // Profile save
      document.getElementById('profile-form').onsubmit = async (e) => {
        e.preventDefault();
        if (!validateProfileForm()) return;
        const priorityEl = document.getElementById('fpc-priority');
        const priorityText = priorityEl.options[priorityEl.selectedIndex].text;
        document.getElementById('fpc-summary').innerText =
          `${document.getElementById('fpc-name').value} (${document.getElementById('fpc-relation').value}) • ${document.getElementById('fpc-phone').value} • ${priorityText}`;
        try {
          await sendToBackend({
            action: "update",
            sheet: "Users",
            filters: { phone: signedInUser.phone },
            data: extractDynamicFormData(document.getElementById('profile-form'))
          });
        } catch (err) {
          console.error("Profile update failed:", err);
        }
        alert("Profile saved.");
      };
      document.getElementById('btn-logout').onclick = logout;

      document.getElementById('btn-add-update').onclick = async () => {
        if (!currentActive) {
          alert("No active meetup.");
          return;
        }
        const updateInput = document.getElementById('meetup-update-input');
        const note = updateInput.value.trim();
        if (!note) {
          setFieldError(updateInput, "Update note cannot be empty");
          return;
        }
        currentActive.updates.push({
          note,
          time: new Date().toLocaleString()
        });
        if (currentActive.meetupId) {
          try {
            await sendToBackend({
              action: "update",
              sheet: "Meetups",
              filters: { id: currentActive.meetupId },
              data: {
                last_update_note: note,
                last_update_at: new Date().toISOString(),
                status: "ACTIVE_WATCH"
              }
            });
          } catch (err) {
            console.error("Meetup update write failed:", err);
          }
        }
        updateInput.value = "";
        removeFieldError(updateInput);
        renderMeetupDetails();
      };

      document.getElementById('btn-capture-prelog').onclick = async () => {
        if (isPrelogCaptureBusy) return;
        const video = document.getElementById('prelog-webcam');
        const canvas = document.getElementById('prelog-canvas');
        const status = document.getElementById('prelog-status');
        const captureBtn = document.getElementById('btn-capture-prelog');
        if (!video.srcObject) {
          status.innerText = "Camera is not active";
          status.style.color = "#ef4444";
          return;
        }
        isPrelogCaptureBusy = true;
        setButtonLoading(captureBtn, true, "Saving...");
        try {
          preLogImageDataUrl = captureFrame(video, canvas);
          closePreLogModal();
          await beginMeetupAfterCapture();
        } finally {
          isPrelogCaptureBusy = false;
          setButtonLoading(captureBtn, false);
        }
      };
      document.getElementById('btn-cancel-prelog').onclick = closePreLogModal;

      // Log form submit => capture photo first, then start watch
      document.getElementById('log-form').onsubmit = async (e) => {
        e.preventDefault();
        if (isLogSubmitting) return;
        if (!validateLogForm()) return;
        isLogSubmitting = true;
        const logSubmitBtn = document.getElementById('btn-log-submit');
        setButtonLoading(logSubmitBtn, true, "Checking...");
        const packageSelect = document.getElementById('log-package');
        const selectedPackage = packageSelect.value;
        if (!selectedPackage) {
          setFieldError(packageSelect, "Please select a package");
          isLogSubmitting = false;
          setButtonLoading(logSubmitBtn, false);
          return;
        }
        const featureRequiredPackage = requiredPackageFromFeatures();
        if (!packageCovers(selectedPackage, featureRequiredPackage)) {
          setFieldError(packageSelect, `Selected package must be ${featureRequiredPackage} or higher for chosen features`);
          isLogSubmitting = false;
          setButtonLoading(logSubmitBtn, false);
          return;
        }
        try {
          const statusResp = await checkPaymentStatus(signedInUser.phone || "", "");
          const paymentState = normalizePaymentStatus(statusResp, signedInUser.package || "Basic");
          signedInUser.isPaid = paymentState.isPaid;
          signedInUser.package = paymentState.package;
          signedInUser.paidTotal = paymentState.paidTotal;
          signedInUser.virtualAccountNumber = paymentState.virtualAccountNumber || signedInUser.virtualAccountNumber || "";
          unlockedPackage = signedInUser.package;
          refreshPaymentUi();
          updateProfileUserDetails();
          try {
            await updateUserInDb(signedInUser.phone, {
              phone_key: phoneKey(signedInUser.phone),
              package: signedInUser.package,
              is_paid: signedInUser.isPaid,
              paid_total: signedInUser.paidTotal,
              virtual_account_number: signedInUser.virtualAccountNumber
            });
          } catch (_) {
            // non-blocking
          }
          if (!signedInUser.isPaid || !packageCovers(signedInUser.package, selectedPackage)) {
            openPaymentModal(signedInUser.virtualAccountNumber || "", selectedPackage);
            startPaymentPolling();
            isLogSubmitting = false;
            setButtonLoading(logSubmitBtn, false);
            return;
          }
          unlockedPackage = selectedPackage;
        } catch (err) {
          setFieldError(packageSelect, "Could not verify payment. Please try again.");
          isLogSubmitting = false;
          setButtonLoading(logSubmitBtn, false);
          return;
        }
        setButtonLoading(logSubmitBtn, true, "Saving...");
        try {
          pendingMeetupData = await collectMeetupDataFromForm();
          await openPreLogModal();
        } finally {
          isLogSubmitting = false;
          setButtonLoading(logSubmitBtn, false);
        }
      };

      // End meetup button => MUST do liveness first
      document.getElementById('btn-end-meetup').onclick = startLivenessCheck;
      document.getElementById('btn-cancel-verify').onclick = closeVerifyModal;
      document.getElementById('btn-verify-capture').onclick = captureAndVerifyLiveness;

      // Keep tel fields numeric at all times
      document.addEventListener('input', (e) => {
        if (e.target.matches('input[type="tel"]')) sanitizeDigitsOnly(e.target);
        if (e.target.matches('.form-input')) removeFieldError(e.target);
      });
      document.addEventListener('change', (e) => {
        if (e.target.matches('.form-input')) removeFieldError(e.target);
      });

      // Startup
      loadNigeriaData();
      updateProfileUserDetails();
      refreshPaymentUi();
      startLandingHeroRotation();
      startTestimonialsRotation();
      showScreen('screen-landing');
      startSocialProof();
      window.addEventListener('beforeunload', stopPaymentPolling);
    });
  </script>
</body>
</html>
